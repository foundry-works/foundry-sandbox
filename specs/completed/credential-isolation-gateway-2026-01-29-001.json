{
  "spec_id": "credential-isolation-gateway-2026-01-29-001",
  "title": "credential-isolation-gateway",
  "generated": "2026-01-29T11:12:10.505150Z",
  "last_updated": "2026-01-29T11:14:49.693633Z",
  "metadata": {
    "description": "",
    "mission": "Keep credentials out of sandbox containers by routing git operations through a gateway service that holds tokens, with sandbox running on Docker internal network with egress proxy.",
    "objectives": [],
    "complexity": "low",
    "estimated_hours": 0,
    "assumptions": [
      "GitHub is the primary git provider; other providers can be added in v2",
      "Docker internal networking provides sufficient isolation when sandbox has NO default network",
      "Session tokens bound to container IP + secret + container ID provide adequate replay protection for v1",
      "One shared gateway service per host (not per-sandbox) is acceptable for v1",
      "Git LFS and cross-host submodules are acceptable to defer to v2",
      "In-memory session storage (lost on gateway restart) is acceptable for v1"
    ],
    "owner": "",
    "category": "implementation",
    "template": "empty"
  },
  "progress_percentage": 0,
  "status": "pending",
  "current_phase": null,
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "credential-isolation-gateway",
      "status": "pending",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4"
      ],
      "total_tasks": 37,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Dangerous Path Blocklist",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "task-1-2",
        "task-1-3",
        "task-1-4",
        "task-1-5",
        "verify-1-1"
      ],
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Prevent mounting credential directories into sandboxes as the first line of defense."
      },
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Add DANGEROUS_PATHS array to validate.sh",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add array with paths: ~/.ssh, ~/.aws, ~/.config/gcloud, ~/.config/gh, ~/.azure, ~/.netrc, ~/.kube, ~/.gnupg, ~/.docker, ~/.npmrc, ~/.pypirc, /var/run/docker.sock, /run/docker.sock",
        "file_path": "lib/validate.sh",
        "acceptance_criteria": [
          "Array contains all 13 dangerous paths",
          "Paths use $HOME expansion"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-2": {
      "type": "task",
      "title": "Implement validate_mount_path function",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Implement function with symlink resolution via realpath -m. Check if mount path is, contains, or is contained by any dangerous path.",
        "file_path": "lib/validate.sh",
        "acceptance_criteria": [
          "Uses realpath -m for canonical path resolution",
          "Handles symlinks correctly",
          "Returns clear error message identifying the dangerous path"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-3": {
      "type": "task",
      "title": "Add --allow-dangerous-mount flag",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add override flag to commands/new.sh for power users who need to bypass the blocklist. Should print warning when used.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Flag is documented in help",
          "Warning printed when flag is used",
          "Mount proceeds with warning"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-4": {
      "type": "task",
      "title": "Integrate mount validation into new.sh",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Call validate_mount_path for each -v/--mount argument before proceeding with sandbox creation.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "All mount paths validated",
          "Blocked mounts exit with error code 1",
          "Override flag bypasses validation"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-5": {
      "type": "task",
      "title": "Add unit tests for path validation",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Test cases: direct dangerous path, symlink to dangerous path, path containing dangerous path, safe paths pass, override flag works.",
        "file_path": "tests/test_validate.sh",
        "acceptance_criteria": [
          "Test direct ~/.ssh mount blocked",
          "Test symlink to ~/.ssh blocked",
          "Test /var/run/docker.sock blocked",
          "Test safe paths allowed"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 1 implementation",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify all dangerous paths blocked, override flag works, symlinks resolved correctly, error messages are clear and actionable.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Gateway Service",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3",
        "task-2-4",
        "task-2-5",
        "task-2-6",
        "task-2-7",
        "task-2-8",
        "task-2-9",
        "task-2-10",
        "task-2-11",
        "verify-2-1"
      ],
      "total_tasks": 12,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Provide HTTP gateway for git operations that holds real credentials, issuing session tokens to sandboxes."
      },
      "dependencies": {
        "blocks": [
          "phase-3"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "Create gateway directory structure",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create gateway/ directory with proper layout for Python Flask app, configs, and Dockerfile.",
        "file_path": "gateway/",
        "acceptance_criteria": [
          "gateway/ directory exists",
          "Contains gateway.py, Dockerfile, requirements.txt placeholders"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "Create allowlist.conf as single source of truth",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create domain allowlist file with format: domain [type]. Include package registries (npm, PyPI, Go, Cargo), CDNs (cloudfront, fastly), AI APIs, GitHub API. Block DoH endpoints with ! prefix.",
        "file_path": "gateway/allowlist.conf",
        "acceptance_criteria": [
          "Contains all package registry domains",
          "Contains CDN wildcards",
          "Contains AI API domains",
          "Blocks DoH endpoints with ! prefix"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "Create build script for config generation",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Script to generate dnsmasq.conf and tinyproxy.conf from allowlist.conf. Single source of truth prevents config drift.",
        "file_path": "gateway/build-configs.sh",
        "acceptance_criteria": [
          "Parses allowlist.conf format",
          "Generates valid dnsmasq.conf",
          "Generates valid tinyproxy.conf",
          "Handles wildcards correctly"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-4": {
      "type": "task",
      "title": "Implement gateway.py Flask application",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Flask app with: /health endpoint, /session/create (Unix socket only) with token+secret generation and container IP binding, /session/destroy, /git/<owner>/<repo>.git/<path> for Smart HTTP proxying. Strict input validation: owner regex ^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$, repo regex ^[a-zA-Z0-9._-]+$, path allowlist (info/refs, git-upload-pack, git-receive-pack only). Session TTL 24h inactivity, 7d absolute. Hard-pin upstream to github.com, disable redirects.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Health check returns 200",
          "Session create returns token+secret with IP binding",
          "Git proxy validates token+secret+IP",
          "Owner/repo validated with regex",
          "Only git endpoints allowed",
          "Upstream pinned to github.com",
          "Redirects disabled"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-5": {
      "type": "task",
      "title": "Implement streaming Git Smart HTTP proxy",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Streaming request/response handling with chunked transfer encoding. Header forwarding (Content-Type, Expect: 100-continue). Authorization header replacement (session token -> GitHub token). Timeouts: 30s connect, 600s transfer. Memory-bounded streaming, no full response buffering.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Streams responses without buffering",
          "Handles chunked encoding",
          "Replaces Authorization header",
          "Timeouts configured correctly",
          "Large repos work without OOM"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-6": {
      "type": "task",
      "title": "Add session management with TTL and GC",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Session storage with multi-factor binding (token, secret, container_id, container_ip, repos, expires_at). TTL: 24h inactivity, 7d absolute max. Garbage collection every 5 minutes.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Sessions expire after 24h inactivity",
          "Sessions expire after 7d absolute",
          "GC runs every 5 minutes",
          "Expired sessions rejected with 401"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-7": {
      "type": "task",
      "title": "Create gateway Dockerfile",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Python/Flask container with gunicorn and dnsmasq. Run as non-root user. Include generated configs.",
        "file_path": "gateway/Dockerfile",
        "acceptance_criteria": [
          "Uses gunicorn for production",
          "Includes dnsmasq",
          "Runs as non-root",
          "Configs generated at build time"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-8": {
      "type": "task",
      "title": "Create requirements.txt",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Python dependencies: Flask, requests, gunicorn.",
        "file_path": "gateway/requirements.txt",
        "acceptance_criteria": [
          "Flask included",
          "requests included",
          "gunicorn included",
          "Versions pinned"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-9": {
      "type": "task",
      "title": "Add LFS detection with 501 response",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Detect LFS endpoints (objects/batch, lfs/*, .git/lfs/*) and return 501 Not Implemented with clear error message.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "LFS endpoints detected",
          "Returns 501 status",
          "Error message explains LFS not supported"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-10": {
      "type": "task",
      "title": "Add IP literal rejection at proxy level",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Proxy rejects requests to IP addresses (e.g., http://1.2.3.4/). Forces all requests through DNS resolution.",
        "file_path": "gateway/tinyproxy.conf",
        "acceptance_criteria": [
          "IP literal requests rejected",
          "Clear error message returned"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-11": {
      "type": "task",
      "title": "Add structured audit logging",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Log session_create, session_destroy, git_access, git_denied, proxy_allow, proxy_deny events as JSON to stderr. Never log tokens or Authorization headers.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Events logged as JSON",
          "Includes timestamp, event type, container_id, ip",
          "Never logs tokens",
          "Never logs Authorization headers"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 2 implementation",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify gateway implements all endpoints per spec, session binding includes multi-factor validation, streaming handles large repos without memory issues, error messages match spec, audit logging works.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Docker Networking",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3",
        "task-3-4",
        "task-3-5",
        "task-3-6",
        "task-3-7",
        "task-3-8",
        "verify-3-1"
      ],
      "total_tasks": 9,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Configure Docker networks to isolate sandbox from external access except through gateway and proxy."
      },
      "dependencies": {
        "blocks": [
          "phase-4"
        ],
        "blocked_by": [
          "phase-2"
        ],
        "depends": []
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "Add sandbox_internal network with ICC disabled",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add network to docker-compose.yml with internal: true and com.docker.network.bridge.enable_icc=false. Sandboxes cannot reach each other.",
        "file_path": "docker-compose.yml",
        "acceptance_criteria": [
          "Network has internal: true",
          "ICC disabled via driver_opts",
          "Network isolated from external"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "Add iptables rules for sandbox isolation",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Allow sandbox->gateway/proxy while blocking sandbox->sandbox. Explicit allow rules for gateway and egress-proxy IPs.",
        "file_path": "safety/network-firewall.sh",
        "acceptance_criteria": [
          "Sandbox can reach gateway",
          "Sandbox can reach egress-proxy",
          "Sandbox cannot reach other sandboxes"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-3": {
      "type": "task",
      "title": "Add gateway service to docker-compose",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Gateway service with access to sandbox_internal and default networks. Unix socket volume mount, healthcheck, GH_TOKEN env var from host.",
        "file_path": "docker-compose.yml",
        "acceptance_criteria": [
          "Gateway on both networks",
          "Unix socket volume mounted",
          "Healthcheck configured",
          "GH_TOKEN passed from host"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-4": {
      "type": "task",
      "title": "Add egress-proxy service",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Tinyproxy service with generated config from allowlist. Access to sandbox_internal and default networks.",
        "file_path": "docker-compose.yml",
        "acceptance_criteria": [
          "Tinyproxy service defined",
          "Uses generated config",
          "On both networks"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-5": {
      "type": "task",
      "title": "Update dev service for internal network only",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Dev service uses sandbox_internal ONLY (remove default). Set HTTP_PROXY/HTTPS_PROXY to egress-proxy, NO_PROXY=gateway, dns: gateway.",
        "file_path": "docker-compose.yml",
        "acceptance_criteria": [
          "Only on sandbox_internal network",
          "Proxy env vars set",
          "DNS set to gateway",
          "NO_PROXY includes gateway"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-6": {
      "type": "task",
      "title": "Add DOCKER-USER chain rules for defense-in-depth",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Block sandbox subnet from direct external egress. Block outbound port 53 except to gateway IP.",
        "file_path": "safety/network-firewall.sh",
        "acceptance_criteria": [
          "DOCKER-USER rules added",
          "Direct egress blocked",
          "Port 53 blocked except gateway"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-7": {
      "type": "task",
      "title": "Configure depends_on with health checks",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Ensure gateway and egress-proxy start before sandbox. Use healthcheck-based depends_on.",
        "file_path": "docker-compose.yml",
        "acceptance_criteria": [
          "Gateway starts first",
          "Egress-proxy starts before sandbox",
          "Health checks used for ordering"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-8": {
      "type": "task",
      "title": "Document network topology",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add documentation explaining the network isolation model, why each layer exists, and proof of no bypass path.",
        "file_path": "docs/security/network-isolation.md",
        "acceptance_criteria": [
          "Explains internal network",
          "Explains ICC disable",
          "Explains proxy routing",
          "Explains DNS isolation"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 3 implementation",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify network isolation is complete - no bypass paths via direct egress, IP literals, or alternate DNS. Verify proxy works for allowed domains. Verify common package manager workflows succeed. Verify startup ordering prevents race conditions. Verify sandboxes cannot ping each other.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Git URL Rewriting & Integration",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-4-1",
        "task-4-2",
        "task-4-3",
        "task-4-4",
        "task-4-5",
        "task-4-6",
        "task-4-7",
        "task-4-8",
        "task-4-9",
        "verify-4-1"
      ],
      "total_tasks": 10,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Automatically rewrite git URLs to use gateway, ensuring credentials never reach sandbox."
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-3"
        ],
        "depends": []
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "Update Dockerfile with git URL rewriting",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Bake /etc/gitconfig with URL rewrite rules: https://github.com/ -> http://gateway:8080/git/, git@github.com: -> http://gateway:8080/git/",
        "file_path": "Dockerfile",
        "acceptance_criteria": [
          "gitconfig has insteadOf rules",
          "Both HTTPS and SSH URLs rewritten",
          "Config baked into image"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-2": {
      "type": "task",
      "title": "Add credential helper for gateway token",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Credential helper that reads token from /run/secrets/gateway_token file. Outputs via git credential protocol (password=<token>). Never logs token.",
        "file_path": "Dockerfile",
        "acceptance_criteria": [
          "Helper reads from file",
          "Uses credential helper protocol",
          "Never echoes token"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-3": {
      "type": "task",
      "title": "Add validate_git_remotes function",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Function to detect embedded credentials in .git/config. Pattern: ://[^:]+:[^@]+@. Returns error if found.",
        "file_path": "lib/validate.sh",
        "acceptance_criteria": [
          "Detects embedded credentials",
          "Pattern matches user:pass@ format",
          "Clear error message"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-4": {
      "type": "task",
      "title": "Integrate remote validation into new.sh",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Call validate_git_remotes on workspace before sandbox creation. Block if embedded credentials found.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Validation runs on workspace",
          "Blocks on embedded creds",
          "Clear error message"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-5": {
      "type": "task",
      "title": "Update new.sh for gateway session creation",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Start gateway if not running. Call /session/create via Unix socket with container ID and repo list. Wait for health check. Write token to tmpfs /run/secrets/gateway_token with 0400 perms.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Starts gateway service",
          "Creates session via socket",
          "Waits for health check",
          "Writes token to tmpfs file",
          "File has 0400 permissions"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-6": {
      "type": "task",
      "title": "Update destroy.sh for session cleanup",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Call /session/destroy via Unix socket on sandbox destroy. Clean up session from gateway.",
        "file_path": "commands/destroy.sh",
        "acceptance_criteria": [
          "Calls session destroy",
          "Session cleaned up",
          "No errors on missing session"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-7": {
      "type": "task",
      "title": "Update start.sh for token refresh",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Generate new session token on container restart. Update /run/secrets/gateway_token. Old token invalidated.",
        "file_path": "commands/start.sh",
        "acceptance_criteria": [
          "Creates new session",
          "Updates token file",
          "Old token rejected"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-8": {
      "type": "task",
      "title": "Add SANDBOX_GATEWAY_ENABLED feature flag",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Environment variable to disable gateway integration for debugging. Default: true. When false, skip gateway setup and use direct git.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Flag defaults to true",
          "false disables gateway",
          "Documented in help"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-9": {
      "type": "task",
      "title": "Add clear error messages for gateway failures",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "When gateway unavailable at start, show clear error with remediation steps. Include: check gateway status, restart gateway, disable via flag.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Clear error message",
          "Remediation steps included",
          "Suggests checking gateway status"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 4 implementation",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify git operations work end-to-end through gateway, credentials never appear in sandbox (except scoped session token in file), feature flag works for rollback, restart behavior generates fresh tokens, error handling is user-friendly with remediation guidance.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    }
  },
  "journal": []
}