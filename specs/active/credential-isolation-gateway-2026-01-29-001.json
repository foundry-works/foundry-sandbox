{
  "spec_id": "credential-isolation-gateway-2026-01-29-001",
  "title": "credential-isolation-gateway",
  "generated": "2026-01-29T11:12:10.505150Z",
  "last_updated": "2026-01-31T17:08:56.142581Z",
  "metadata": {
    "description": "Extends existing credential isolation mode by adding a GitHub gateway + egress proxy stack while keeping the api-proxy for AI/API keys. This integration is only active when --isolate-credentials is enabled; normal mode remains unchanged.",
    "integration_model": {
      "mode": "credential-isolation-only",
      "summary": "When --isolate-credentials is enabled, run api-proxy + gateway + egress-proxy; otherwise, behavior is unchanged.",
      "components": {
        "api_proxy": "Retained for AI/API keys; continues to inject credentials for API traffic.",
        "gateway": "New GitHub gateway service; holds GH_TOKEN and issues sandbox session tokens.",
        "egress_proxy": "New allowlist-based proxy for non-git outbound traffic in isolation mode."
      },
      "activation": {
        "isolation_enabled": "When --isolate-credentials is enabled, gateway and egress-proxy services start alongside api-proxy.",
        "isolation_disabled": "Behavior is completely unchanged: no gateway service, no egress-proxy service, api-proxy remains in place for credential injection as before. Non-isolated mode operates as it did prior to this credential-isolation gateway feature."
      },
      "sandbox_behavior": {
        "isolation_enabled": "Sandbox receives no GH_TOKEN, uses git URL rewrite to gateway and a session token helper; gh credential helper disabled.",
        "isolation_disabled": "Existing git behavior unchanged."
      },
      "proxy_routing_model": {
        "overview": "Default HTTP(S) traffic routes through egress-proxy for allowlist enforcement; credentialed API calls route through api-proxy for credential injection; git traffic uses gateway URL rewrite and bypasses proxies entirely.",
        "default_outbound": {
          "description": "HTTP_PROXY and HTTPS_PROXY point to egress-proxy for general-purpose outbound traffic.",
          "purpose": "Enforce domain allowlist on package manager downloads, CDN access, and other non-credentialed traffic."
        },
        "credentialed_apis": {
          "description": "Tool-specific proxy/env configuration routes credentialed API calls through api-proxy (e.g., AI API keys).",
          "purpose": "Preserve credential injection for tools that need API authentication without exposing credentials to egress-proxy.",
          "mechanism": "Specific tools (e.g., Claude CLI, LLM tools) bypass HTTP_PROXY and use api-proxy directly via tool-level env or proxy configuration."
        },
        "git_traffic": {
          "description": "Git URLs are rewritten at container start (https://github.com/ -> http://gateway:8080/git/, git@github.com: -> http://gateway:8080/git/). Session tokens stored in /run/secrets/gateway_token. Git traffic bypasses all proxies.",
          "purpose": "Ensure all credentialed git operations flow through gateway; credentials never exposed to sandbox.",
          "token_binding": "Tokens multi-factor bound to container IP, secret, container ID; 24h inactivity TTL, 7d absolute max."
        },
        "no_proxy_list": {
          "description": "NO_PROXY includes: api-proxy, gateway, localhost, 127.0.0.1.",
          "purpose": "Prevent routing to internal services through proxies; avoid loops and ensure direct container-to-service connections."
        }
      },
      "credential_exposure_guarantees": {
        "gh_token_isolation": "GH_TOKEN is only exposed to the gateway service, never to sandbox containers. When --isolate-credentials is enabled, GH_TOKEN is unset in dev service and export_gh_token is gated in commands/new.sh and commands/start.sh.",
        "gh_credential_helper_disablement": "When gateway is enabled, lib/container_config.sh must disable 'gh auth git-credential' helper. Credentials are obtained via session token file and gateway URL rewrite instead.",
        "api_credential_preservation": "api-proxy credential injection for AI/API keys is preserved; tool-specific env/proxy config ensures credentialed calls reach api-proxy without double-proxying through egress-proxy."
      },
      "migration_from_current_api_proxy_default": {
        "current_behavior": "Current isolate-credentials mode routes all HTTP(S) traffic through api-proxy.",
        "new_behavior": "Split into default egress-proxy (general traffic) + tool-specific api-proxy (credentialed APIs), reducing api-proxy load and improving isolation.",
        "implementation_notes": "Explicit tool/env wiring required to preserve credential injection; default HTTP_PROXY/HTTPS_PROXY point to egress-proxy, but credentialed tools must bypass it."
      }
    },
    "mission": "Keep git credentials out of sandbox containers by routing all credentialed GitHub operations through a gateway service, running sandboxes on an internal Docker network with an egress proxy, and extending the existing credential-isolation stack.",
    "objectives": [
      "No GitHub tokens or GH CLI auth material inside sandbox containers",
      "All credentialed git traffic flows through gateway with enforceable policy",
      "Network topology prevents direct external egress from sandboxes",
      "Integrate with existing api-proxy credential isolation override without changing default (non-isolated) behavior"
    ],
    "complexity": "low",
    "estimated_hours": 0,
    "assumptions": [
      "GitHub is the only git provider for v1",
      "Docker internal networking plus egress proxy provides sufficient isolation when sandbox has no default network",
      "Session tokens bound to container IP + secret + container ID provide adequate replay protection for v1",
      "One shared gateway service per host (not per-sandbox) is acceptable for v1",
      "Git LFS and cross-host submodules are acceptable to defer to v2",
      "In-memory session storage (lost on gateway restart) is acceptable for v1",
      "Gateway and api-proxy run together in the credential-isolation compose override",
      "Egress-proxy is added only in credential-isolation mode",
      "Allowlist single source of truth shared across firewall/proxy/egress-proxy",
      "Current limited-mode allowlist is embedded in safety/network-firewall.sh and must be migrated into allowlist.conf to avoid drift",
      "Base docker-compose.yml currently passes GH_TOKEN into dev; the credential-isolation override must explicitly unset it when gateway is enabled",
      "lib/container_config.sh currently configures gh auth git-credential; this must be disabled when gateway is enabled",
      "Credential-isolation override currently only adds api-proxy; gateway and egress-proxy services will be new additions",
      "credential-isolation network currently sets internal: true only; driver_opts must disable ICC to prevent sandbox-to-sandbox traffic",
      "GH_TOKEN is only exposed to gateway service in credential-isolation mode",
      "When gateway is enabled, sandboxes use git URL rewrite + session token helper; gh credential helper is disabled",
      "Non-isolated mode remains unchanged",
      "Proxy routing must preserve api-proxy credential injection; egress-proxy must not bypass credentialed API traffic",
      "Allowlist single source must include existing CIDR allowlists, rotating domains, and DNS handling from safety/network-firewall.sh",
      "Current credential-isolation mode routes all HTTP(S) via api-proxy; migration to egress-proxy requires explicit per-tool proxy/env wiring to preserve credential injection.",
      "export_gh_token currently runs during sandbox start; it must be gated so GH_TOKEN is not exported to dev when gateway mode is enabled."
    ],
    "owner": "",
    "category": "implementation",
    "template": "empty",
    "review_notes": [
      "Proxy routing integration needs explicit tool/env split: default HTTP(S)_PROXY to egress-proxy, but credentialed API calls must be routed to api-proxy without double-proxying or losing credential injection.",
      "Base docker-compose.yml passes GH_TOKEN into dev; credential-isolation override must explicitly unset GH_TOKEN for dev and only expose it to gateway.",
      "Disable gh credential helper when gateway enabled in lib/container_config.sh (not only Dockerfile); current ensure_github_https_git always configures gh helper.",
      "Clarify interaction between limited-mode firewall rules and new egress-proxy: whether firewall remains enabled, is generated from allowlist.conf, or is bypassed in isolate-credentials mode.",
      "Specify Unix socket plumbing for gateway session creation (volume path, ownership/permissions, and how commands/new.sh invokes it).",
      "Note docker network ICC disablement requires driver_opts and should be validated against Docker version/behavior to avoid breaking gateway/api-proxy connectivity.",
      "Base docker-compose.yml exposes GH_TOKEN to dev; credential-isolation override must explicitly unset it AND export_gh_token in commands/new.sh should be conditional to avoid populating GH_TOKEN when isolation is enabled.",
      "Current credential-isolation routes all HTTP(S) via api-proxy; spec\u2019s proposed split (default egress-proxy + tool-specific api-proxy) needs explicit implementation details (envs/wrappers) to avoid ambiguity.",
      "Credential-isolation network is already internal: true in docker-compose.credential-isolation.yml; remaining work is ICC disablement and validation, not adding internal network from scratch.",
      "Allowlist migration must include the full current safety/network-firewall.sh domain list (Cursor expanded domains, OAuth endpoints, etc.) to avoid regressions when moving to allowlist.conf."
    ],
    "proxy_routing_design": {
      "overview": "Traffic splits between egress-proxy (default outbound, allowlist enforcement) and api-proxy (tool-specific credentialed APIs, credential injection). Git traffic bypasses all proxies via gateway URL rewriting. NO_PROXY prevents loops through internal services. Current implementation routes all HTTP(S) via api-proxy; planned migration splits default traffic to egress-proxy with explicit tool-level api-proxy routing.",
      "traffic_splitting": {
        "default_outbound": {
          "proxy": "egress-proxy:8080",
          "env": "HTTP_PROXY=http://egress-proxy:8080, HTTPS_PROXY=http://egress-proxy:8080",
          "purpose": "Route general outbound traffic (package managers, CDNs, non-credentialed APIs) through allowlist enforcement. Enforces allowlist.conf domains.",
          "tools": "npm, pip, curl, wget, go get, cargo, etc."
        },
        "credentialed_apis": {
          "proxy": "api-proxy:8888 (direct, bypassing HTTP_PROXY)",
          "mechanism": "Tool-specific proxy override: NO_PROXY=api-proxy, HTTP_PROXY overridden to api-proxy or via direct tool config (e.g., Claude CLI checks CLAUDE_API_PROXY). Wrapper scripts in sandbox PATH or tool-level env parsing.",
          "purpose": "Preserve credential injection for tools requiring API keys without routing through egress-proxy allowlist. Avoids double-proxying and exposes credentials only to credentialed proxy.",
          "tools": "Claude CLI, internal LLM tools, AI API clients"
        },
        "git_traffic": {
          "proxy": "None (bypasses all proxies)",
          "mechanism": "URL rewriting at container start: https://github.com -> http://gateway:8080/git/, git@github.com: -> http://gateway:8080/git/. Credential helper reads token from /run/secrets/gateway_token file.",
          "purpose": "Ensure all credentialed git operations flow through gateway. Credentials never exposed to sandbox or proxies.",
          "env": "Gateway token bound to container IP, secret, container_id. Session TTL 24h inactivity, 7d absolute max."
        }
      },
      "no_proxy_configuration": {
        "list": "api-proxy, gateway, localhost, 127.0.0.1, *.local, 169.254.* (docker metadata)",
        "purpose": "Prevent routing internal service calls through proxies. Critical for: gateway session validation, api-proxy health checks, internal service communication, localhost debugging.",
        "validation": "All internal IPs/hostnames must be in NO_PROXY to avoid loops and connection failures."
      },
      "current_state": "Today, --isolate-credentials mode routes all HTTP(S) traffic via api-proxy:8888. All outbound (package managers, CDNs, APIs, git) flows through api-proxy. Works but creates bottleneck, reduces isolation (non-credentialed traffic mixed with credentials), and complicates allowlist enforcement.",
      "migration_path": {
        "phase_1": "Deploy egress-proxy alongside api-proxy in credential-isolation compose override. Build tinyproxy config from allowlist.conf.",
        "phase_2": "Identify credentialed tools: Claude CLI, internal LLM clients. Create tool-specific proxy wrappers or env overrides.",
        "phase_3": "Default HTTP_PROXY=egress-proxy for all tools. Credentialed tools explicitly bypass egress-proxy via NO_PROXY=api-proxy and tool-level proxy override.",
        "phase_4": "Validate workflows: npm/pip/cargo through egress-proxy, Claude CLI through api-proxy, git through gateway. Allowlist single source drives proxy config generation.",
        "phase_5": "Gradual rollout with EGRESS_PROXY_ENABLED feature flag (default true, can disable for rollback/debugging).",
        "validation": "Package manager installs succeed through egress-proxy. Claude CLI authenticates via api-proxy. Git operations via gateway. Health checks and internal services don't loop through proxies."
      },
      "implementation_details": {
        "tool_wrappers": "Create /usr/local/bin/claude-wrapper that sets HTTP_PROXY to api-proxy:8888 before exec, or tool detects CLAUDE_API_PROXY env and uses it. Alternative: Tool-level NO_PROXY configuration.",
        "env_precedence": "Tool-specific env overrides (e.g., CLAUDE_API_PROXY, INTERNAL_LLM_PROXY) take precedence over global HTTP_PROXY. Falls back to HTTP_PROXY if tool-specific not set.",
        "allowlist_single_source": "gateway/allowlist.conf is single source of truth. build-configs.sh generates tinyproxy.conf and dnsmasq.conf from allowlist.conf. Firewall rules also generated from allowlist to avoid drift.",
        "testing": "Before migration: verify egress-proxy blocks non-allowlisted domains with 403. Verify credentialed tools still work via api-proxy. Verify git through gateway. Verify NO_PROXY prevents internal loops."
      },
      "rollback": "Feature flag EGRESS_PROXY_ENABLED=false or SANDBOX_PROXY_ROUTING=api-proxy-only reverts to all HTTP_PROXY=api-proxy:8888 globally for debugging or emergency rollback."
    }
  },
  "progress_percentage": 19,
  "status": "in_progress",
  "current_phase": "phase-1",
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "credential-isolation-gateway",
      "status": "in_progress",
      "parent": null,
      "children": [
        "phase-0",
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4"
      ],
      "total_tasks": 42,
      "completed_tasks": 8,
      "metadata": {
        "purpose": "Proxy routing diagram (credential isolation):\n  dev container -> egress-proxy (default HTTP(S)_PROXY) -> allowlisted internet\n  dev container -> api-proxy (tool-specific proxy/env) -> credential injection -> internet\n  dev container git traffic -> gateway (URL rewrite) -> github.com\n  NO_PROXY includes api-proxy,gateway,localhost,127.0.0.1 to avoid loops.",
        "category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-0": {
      "type": "phase",
      "title": "Integration Model",
      "status": "completed",
      "parent": "spec-root",
      "children": [
        "task-0-1",
        "task-0-2",
        "verify-0-1"
      ],
      "total_tasks": 3,
      "completed_tasks": 3,
      "metadata": {
        "purpose": "",
        "description": "Lock down how the gateway integrates with existing credential isolation. Add proxy-routing design: default HTTP_PROXY/HTTPS_PROXY point to egress-proxy for general outbound; api-proxy remains the credential injector via tool-specific proxy/env config; NO_PROXY includes api-proxy,gateway,localhost,127.0.0.1 to avoid loops; git traffic always uses gateway URL rewrite and bypasses proxies.",
        "needs_journaling": true,
        "completed_at": "2026-01-31T17:08:56.142355Z"
      },
      "dependencies": {
        "blocks": [
          "phase-1"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-0-1": {
      "type": "task",
      "title": "Document integration constraints",
      "status": "completed",
      "parent": "phase-0",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Explicitly state that api-proxy remains for AI/API keys, gateway+egress-proxy only run when --isolate-credentials is enabled, and non-isolated mode is unchanged. Note that GH_TOKEN is never exposed to sandbox when gateway enabled and gh credential helper is disabled. Clarify how HTTP(S) proxy routing works between api-proxy and egress-proxy so credential injection is preserved.",
        "file_path": "specs/pending/credential-isolation-gateway-2026-01-29-001.json",
        "acceptance_criteria": [
          "Integration model captured in spec metadata",
          "Non-isolated behavior unchanged is explicit",
          "Gateway behavior and gh credential helper disablement are explicit",
          "Proxy routing preserves api-proxy credential injection"
        ],
        "task_category": "documentation",
        "started_at": "2026-01-31T17:02:13.290859Z",
        "completed_at": "2026-01-31T17:03:37.485981Z",
        "actual_hours": 0.02
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-0-1": {
      "type": "verify",
      "title": "Fidelity review: Integration model clarity",
      "status": "completed",
      "parent": "phase-0",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Verify the integration model is explicit and unambiguous, and aligns with existing credential isolation behavior.",
        "verification_type": "fidelity",
        "started_at": "2026-01-31T17:07:09.970097Z",
        "completed_at": "2026-01-31T17:08:56.142302Z",
        "needs_journaling": false,
        "actual_hours": 0.03,
        "journaled_at": "2026-01-31T17:08:56.142407Z"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Dangerous Path Blocklist",
      "status": "in_progress",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "task-1-2",
        "task-1-3",
        "task-1-4",
        "task-1-5",
        "verify-1-1"
      ],
      "total_tasks": 6,
      "completed_tasks": 5,
      "metadata": {
        "purpose": "",
        "description": "Prevent mounting credential directories into sandboxes as the first line of defense."
      },
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Add DANGEROUS_PATHS array to validate.sh",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Add array with paths: ~/.ssh, ~/.aws, ~/.config/gcloud, ~/.config/gh, ~/.azure, ~/.netrc, ~/.kube, ~/.gnupg, ~/.docker, ~/.npmrc, ~/.pypirc, /var/run/docker.sock, /run/docker.sock",
        "file_path": "lib/validate.sh",
        "acceptance_criteria": [
          "Array contains all 13 dangerous paths",
          "Paths use $HOME expansion"
        ],
        "task_category": "implementation",
        "started_at": "2026-01-31T17:02:13.290859Z",
        "completed_at": "2026-01-31T17:03:37.485981Z",
        "actual_hours": 0.02
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-2": {
      "type": "task",
      "title": "Implement validate_mount_path function",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Implement function with symlink resolution via realpath -m. Check if mount path is, contains, or is contained by any dangerous path.",
        "file_path": "lib/validate.sh",
        "acceptance_criteria": [
          "Uses realpath -m for canonical path resolution",
          "Handles symlinks correctly",
          "Returns clear error message identifying the dangerous path"
        ],
        "task_category": "implementation",
        "started_at": "2026-01-31T17:03:45.445555Z",
        "completed_at": "2026-01-31T17:06:09.710789Z",
        "actual_hours": 0.04
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-3": {
      "type": "task",
      "title": "Add --allow-dangerous-mount flag",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Add override flag to commands/new.sh for power users who need to bypass the blocklist. Should print warning when used.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Flag is documented in help",
          "Warning printed when flag is used",
          "Mount proceeds with warning"
        ],
        "task_category": "implementation",
        "started_at": "2026-01-31T17:02:13.290859Z",
        "completed_at": "2026-01-31T17:03:37.485981Z",
        "actual_hours": 0.02
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-4": {
      "type": "task",
      "title": "Integrate mount validation into new.sh",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Call validate_mount_path for each -v/--mount argument before proceeding with sandbox creation.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "All mount paths validated",
          "Blocked mounts exit with error code 1",
          "Override flag bypasses validation"
        ],
        "task_category": "implementation",
        "started_at": "2026-01-31T17:03:45.445555Z",
        "completed_at": "2026-01-31T17:06:09.710789Z",
        "actual_hours": 0.04
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-5": {
      "type": "task",
      "title": "Add unit tests for path validation",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Test cases: direct dangerous path, symlink to dangerous path, path containing dangerous path, safe paths pass, override flag works.",
        "file_path": "tests/test_validate.sh",
        "acceptance_criteria": [
          "Test direct ~/.ssh mount blocked",
          "Test symlink to ~/.ssh blocked",
          "Test /var/run/docker.sock blocked",
          "Test safe paths allowed"
        ],
        "task_category": "implementation",
        "started_at": "2026-01-31T17:06:17.238740Z",
        "completed_at": "2026-01-31T17:07:01.649835Z",
        "actual_hours": 0.01
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 1 implementation",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify all dangerous paths blocked, override flag works, symlinks resolved correctly, error messages are clear and actionable.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Gateway Service",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3",
        "task-2-4",
        "task-2-5",
        "task-2-6",
        "task-2-7",
        "task-2-8",
        "task-2-9",
        "task-2-10",
        "task-2-11",
        "verify-2-1"
      ],
      "total_tasks": 12,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Provide HTTP gateway for git operations that holds real credentials, issuing session tokens to sandboxes."
      },
      "dependencies": {
        "blocks": [
          "phase-3"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "Create gateway directory structure",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create gateway/ directory with proper layout for Python Flask app, configs, and Dockerfile.",
        "file_path": "gateway/",
        "acceptance_criteria": [
          "gateway/ directory exists",
          "Contains gateway.py, Dockerfile, requirements.txt placeholders"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "Create allowlist.conf as single source of truth",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create domain allowlist file with format: domain [type]. Include package registries (npm, PyPI, Go, Cargo), CDNs (cloudfront, fastly), AI APIs, GitHub API. Block DoH endpoints with ! prefix. This file becomes the single source of truth for both egress-proxy configs and limited-mode firewall allowlists.",
        "file_path": "gateway/allowlist.conf",
        "acceptance_criteria": [
          "Contains all package registry domains",
          "Contains CDN wildcards",
          "Contains AI API domains",
          "Blocks DoH endpoints with ! prefix",
          "Includes existing limited-mode allowlist entries from safety/network-firewall.sh",
          "Referenced by firewall allowlist generation",
          "Includes Cloudflare/GitHub CIDR allowlists or references generated equivalents",
          "Includes rotating domains used in limited mode",
          "Captures DNS handling requirements from safety/network-firewall.sh"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "Create build script for config generation",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Script to generate dnsmasq.conf and tinyproxy.conf from allowlist.conf. Single source of truth prevents config drift. Also generates firewall allowlist artifacts used by safety/network-firewall.sh (or a new include file).",
        "file_path": "gateway/build-configs.sh",
        "acceptance_criteria": [
          "Parses allowlist.conf format",
          "Generates valid dnsmasq.conf",
          "Generates valid tinyproxy.conf",
          "Handles wildcards correctly",
          "Generates firewall allowlist include",
          "safety/network-firewall.sh consumes the generated allowlist include (or an equivalent generated list)",
          "Preserves CIDR and rotating-domain allowlists from current firewall rules"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-4": {
      "type": "task",
      "title": "Implement gateway.py Flask application",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Flask app with: /health endpoint, /session/create (Unix socket only) with token+secret generation and container IP binding, /session/destroy, /git/<owner>/<repo>.git/<path> for Smart HTTP proxying. Strict input validation: owner regex ^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$, repo regex ^[a-zA-Z0-9._-]+$, path allowlist (info/refs, git-upload-pack, git-receive-pack only). Session TTL 24h inactivity, 7d absolute. Hard-pin upstream to github.com, disable redirects. Policy hooks allow read/write decisions per repo (default allows receive-pack).",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Health check returns 200",
          "Session create returns token+secret with IP binding",
          "Git proxy validates token+secret+IP",
          "Owner/repo validated with regex",
          "Only git endpoints allowed",
          "Upstream pinned to github.com",
          "Redirects disabled",
          "Policy hook can deny specific repos/ops"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-5": {
      "type": "task",
      "title": "Implement streaming Git Smart HTTP proxy",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Streaming request/response handling with chunked transfer encoding. Header forwarding (Content-Type, Expect: 100-continue). Authorization header replacement (session token -> GitHub token). Timeouts: 30s connect, 600s transfer. Memory-bounded streaming, no full response buffering. Explicitly allow receive-pack (push) by default.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Streams responses without buffering",
          "Handles chunked encoding",
          "Replaces Authorization header",
          "Timeouts configured correctly",
          "Large repos work without OOM"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-6": {
      "type": "task",
      "title": "Add session management with TTL and GC",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Session storage with multi-factor binding (token, secret, container_id, container_ip, repos, expires_at). TTL: 24h inactivity, 7d absolute max. Garbage collection every 5 minutes.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Sessions expire after 24h inactivity",
          "Sessions expire after 7d absolute",
          "GC runs every 5 minutes",
          "Expired sessions rejected with 401"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-7": {
      "type": "task",
      "title": "Create gateway Dockerfile",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Python/Flask container with gunicorn and dnsmasq. Run as non-root user. Include generated configs.",
        "file_path": "gateway/Dockerfile",
        "acceptance_criteria": [
          "Uses gunicorn for production",
          "Includes dnsmasq",
          "Runs as non-root",
          "Configs generated at build time"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-8": {
      "type": "task",
      "title": "Create requirements.txt",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Python dependencies: Flask, requests, gunicorn.",
        "file_path": "gateway/requirements.txt",
        "acceptance_criteria": [
          "Flask included",
          "requests included",
          "gunicorn included",
          "Versions pinned"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-9": {
      "type": "task",
      "title": "Add LFS detection with 501 response",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Detect LFS endpoints (objects/batch, lfs/*, .git/lfs/*) and return 501 Not Implemented with clear error message.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "LFS endpoints detected",
          "Returns 501 status",
          "Error message explains LFS not supported"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-10": {
      "type": "task",
      "title": "Add IP literal rejection at proxy level",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Proxy rejects requests to IP addresses (e.g., http://1.2.3.4/). Forces all requests through DNS resolution.",
        "file_path": "gateway/tinyproxy.conf",
        "acceptance_criteria": [
          "IP literal requests rejected",
          "Clear error message returned"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-11": {
      "type": "task",
      "title": "Add structured audit logging",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Log session_create, session_destroy, git_access, git_denied, proxy_allow, proxy_deny events as JSON to stderr. Never log tokens or Authorization headers.",
        "file_path": "gateway/gateway.py",
        "acceptance_criteria": [
          "Events logged as JSON",
          "Includes timestamp, event type, container_id, ip",
          "Never logs tokens",
          "Never logs Authorization headers"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 2 implementation",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify gateway implements all endpoints per spec, session binding includes multi-factor validation, streaming handles large repos without memory issues, error messages match spec, audit logging works.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Docker Networking",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3",
        "task-3-4",
        "task-3-5",
        "task-3-6",
        "task-3-7",
        "task-3-8",
        "verify-3-1",
        "task-3-9"
      ],
      "total_tasks": 10,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Configure Docker networks to isolate sandbox from external access except through gateway and proxy."
      },
      "dependencies": {
        "blocks": [
          "phase-4"
        ],
        "blocked_by": [
          "phase-2"
        ],
        "depends": []
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "Add sandbox_internal network with ICC disabled",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add credential-isolation network with internal: true and ICC disabled. Sandboxes cannot reach each other. Defined in credential isolation override so gateway/api-proxy/dev share an isolated network.",
        "file_path": "docker-compose.credential-isolation.yml",
        "acceptance_criteria": [
          "Network has internal: true",
          "ICC disabled via driver_opts",
          "Network isolated from external",
          "Gateway/api-proxy/dev attached to credential-isolation network"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "Add iptables rules for sandbox isolation",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add iptables rules for sandbox isolation as defense-in-depth (optional when internal-only network is enforced). Allow sandbox->gateway/proxy while blocking sandbox->sandbox. Explicit allow rules for gateway and egress-proxy IPs.",
        "file_path": "safety/network-firewall.sh",
        "acceptance_criteria": [
          "Sandbox can reach gateway",
          "Sandbox can reach egress-proxy",
          "Sandbox cannot reach other sandboxes"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-3": {
      "type": "task",
      "title": "Add gateway service to docker-compose",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Gateway service added to credential isolation override alongside api-proxy. Gateway connected to credential-isolation and default networks. Unix socket volume mount, healthcheck, GitHub token env var from host.",
        "file_path": "docker-compose.credential-isolation.yml",
        "acceptance_criteria": [
          "Gateway on both networks",
          "Unix socket volume mounted",
          "Healthcheck configured",
          "GH_TOKEN passed to gateway from host",
          "api-proxy unchanged and still healthy"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-4": {
      "type": "task",
      "title": "Add egress-proxy service",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Egress-proxy (tinyproxy) service with generated config from allowlist. Access to credential-isolation and default networks. Used for non-git outbound traffic in credential-isolation mode.",
        "file_path": "docker-compose.credential-isolation.yml",
        "acceptance_criteria": [
          "Tinyproxy service defined",
          "Uses generated config",
          "On both networks",
          "dev uses proxy env vars"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-5": {
      "type": "task",
      "title": "Update dev service for internal network only",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Dev service uses credential-isolation ONLY (remove default). Set HTTP_PROXY/HTTPS_PROXY to egress-proxy, NO_PROXY=gateway, dns: gateway. Ensure GH_TOKEN is not present in dev when gateway enabled.",
        "file_path": "docker-compose.credential-isolation.yml",
        "acceptance_criteria": [
          "Only on credential-isolation network",
          "Proxy env vars set",
          "DNS set to gateway",
          "NO_PROXY includes gateway",
          "GH_TOKEN not present in dev"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-6": {
      "type": "task",
      "title": "Add DOCKER-USER chain rules for defense-in-depth",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add DOCKER-USER chain rules for defense-in-depth (optional when internal-only network is enforced). Block sandbox subnet from direct external egress. Block outbound port 53 except to gateway IP.",
        "file_path": "safety/network-firewall.sh",
        "acceptance_criteria": [
          "DOCKER-USER rules added",
          "Direct egress blocked",
          "Port 53 blocked except gateway"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-7": {
      "type": "task",
      "title": "Configure depends_on with health checks",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Ensure gateway, egress-proxy, and api-proxy start before sandbox. Use healthcheck-based depends_on in credential isolation override.",
        "file_path": "docker-compose.credential-isolation.yml",
        "acceptance_criteria": [
          "Gateway starts first",
          "Egress-proxy starts before sandbox",
          "API proxy starts before sandbox",
          "Health checks used for ordering"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-8": {
      "type": "task",
      "title": "Document network topology",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add documentation explaining the network isolation model, why each layer exists, and proof of no bypass path.",
        "file_path": "docs/security/network-isolation.md",
        "acceptance_criteria": [
          "Explains internal network",
          "Explains ICC disable",
          "Explains proxy routing",
          "Explains DNS isolation"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 3 implementation",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify network isolation is complete - no bypass paths via direct egress, IP literals, or alternate DNS. Verify proxy works for allowed domains. Verify common package manager workflows succeed. Verify startup ordering prevents race conditions. Verify sandboxes cannot ping each other. Verify api-proxy and gateway both healthy before dev starts. Verify dev has no GH_TOKEN. Verify allowlist single source drives proxy/firewall rules.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Git URL Rewriting & Integration",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-4-1",
        "task-4-2",
        "task-4-3",
        "task-4-4",
        "task-4-5",
        "task-4-6",
        "task-4-7",
        "task-4-8",
        "task-4-9",
        "verify-4-1",
        "task-4-10"
      ],
      "total_tasks": 11,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Automatically rewrite git URLs to use gateway, ensuring credentials never reach sandbox."
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-3"
        ],
        "depends": []
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "Update Dockerfile with git URL rewriting",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Bake /etc/gitconfig with URL rewrite rules: https://github.com/ -> http://gateway:8080/git/, git@github.com: -> http://gateway:8080/git/. Ensure no gh credential helper is configured when gateway is enabled.",
        "file_path": "Dockerfile",
        "acceptance_criteria": [
          "gitconfig has insteadOf rules",
          "Both HTTPS and SSH URLs rewritten",
          "Config baked into image"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-2": {
      "type": "task",
      "title": "Add credential helper for gateway token",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Credential helper that reads token from /run/secrets/gateway_token file. Outputs via git credential protocol (password=<token>). Never logs token. When gateway enabled, disable gh auth git-credential to avoid container-side token usage.",
        "file_path": "Dockerfile",
        "acceptance_criteria": [
          "Helper reads from file",
          "Uses credential helper protocol",
          "Never echoes token",
          "gh credential helper disabled when gateway enabled"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-3": {
      "type": "task",
      "title": "Add validate_git_remotes function",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Function to detect embedded credentials in .git/config. Pattern: ://[^:]+:[^@]+@. Returns error if found.",
        "file_path": "lib/validate.sh",
        "acceptance_criteria": [
          "Detects embedded credentials",
          "Pattern matches user:pass@ format",
          "Clear error message"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-4": {
      "type": "task",
      "title": "Integrate remote validation into new.sh",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Call validate_git_remotes on workspace before sandbox creation. Block if embedded credentials found.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Validation runs on workspace",
          "Blocks on embedded creds",
          "Clear error message"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-5": {
      "type": "task",
      "title": "Update new.sh for gateway session creation",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Start gateway if not running. Call /session/create via Unix socket with container ID and repo list. Wait for health check. Write token to tmpfs /run/secrets/gateway_token with 0400 perms. Integrate with credential isolation compose override startup.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Starts gateway service",
          "Creates session via socket",
          "Waits for health check",
          "Writes token to tmpfs file",
          "File has 0400 permissions"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-6": {
      "type": "task",
      "title": "Update destroy.sh for session cleanup",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Call /session/destroy via Unix socket on sandbox destroy. Clean up session from gateway.",
        "file_path": "commands/destroy.sh",
        "acceptance_criteria": [
          "Calls session destroy",
          "Session cleaned up",
          "No errors on missing session"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-7": {
      "type": "task",
      "title": "Update start.sh for token refresh",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Generate new session token on container restart. Update /run/secrets/gateway_token. Old token invalidated.",
        "file_path": "commands/start.sh",
        "acceptance_criteria": [
          "Creates new session",
          "Updates token file",
          "Old token rejected"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-8": {
      "type": "task",
      "title": "Add SANDBOX_GATEWAY_ENABLED feature flag",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Environment variable to disable gateway integration for debugging. Default: true. When false, skip gateway setup and use direct git.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Flag defaults to true",
          "false disables gateway",
          "Documented in help"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-9": {
      "type": "task",
      "title": "Add clear error messages for gateway failures",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "When gateway unavailable at start, show clear error with remediation steps. Include: check gateway status, restart gateway, disable via flag.",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Clear error message",
          "Remediation steps included",
          "Suggests checking gateway status"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Fidelity review: Phase 4 implementation",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify git operations work end-to-end through gateway (clone/fetch/push). Credentials never appear in sandbox (except scoped session token in file). Feature flag works for rollback. Restart behavior generates fresh tokens. Error handling is user-friendly with remediation guidance. Policy hook correctly allows/denies repo/operation.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-10": {
      "type": "task",
      "title": "Disable gh credential helper when gateway enabled",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update lib/container_config.sh to skip or unset 'gh auth git-credential' helper when SANDBOX_GATEWAY_ENABLED=true. Ensure HTTPS rewrite is still applied.",
        "file_path": "lib/container_config.sh",
        "acceptance_criteria": [
          "gh credential helper not configured when gateway enabled",
          "HTTPS rewrite still applied",
          "No token material written inside container"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-9": {
      "type": "task",
      "title": "Ensure GH_TOKEN only exposed to gateway",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update docker-compose.credential-isolation.yml to ensure dev does not receive GH_TOKEN, while gateway does. If base compose defines GH_TOKEN on dev, explicitly override/unset it. Also gate export_gh_token in commands/new.sh and commands/start.sh when isolate-credentials is enabled so GH_TOKEN is not injected into dev.",
        "file_path": "docker-compose.credential-isolation.yml, commands/new.sh, commands/start.sh",
        "acceptance_criteria": [
          "dev has no GH_TOKEN env",
          "gateway has GH_TOKEN env",
          "credentialed git still works via gateway",
          "export_gh_token skipped for dev when isolate-credentials is enabled (gateway receives GH_TOKEN only)"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-0-2": {
      "type": "task",
      "title": "Document proxy routing design",
      "status": "completed",
      "parent": "phase-0",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "description": "Define how traffic splits between api-proxy (credential injection) and egress-proxy (allowlist). Specify default HTTP_PROXY/HTTPS_PROXY to egress-proxy, tool-specific proxy/env for credentialed API calls via api-proxy, NO_PROXY list to avoid loops, and confirm git traffic uses gateway URL rewrite and bypasses proxies. Note current isolate mode routes all HTTP(S) via api-proxy today, and document the migration steps to egress-proxy + tool-specific api-proxy routing.",
        "file_path": "specs/pending/credential-isolation-gateway-2026-01-29-001.json",
        "acceptance_criteria": [
          "Default outbound uses egress-proxy",
          "Credentialed API calls use api-proxy",
          "NO_PROXY avoids api-proxy/gateway loops",
          "Git traffic bypasses proxies via gateway rewrite",
          "Docs note current api-proxy default and planned migration to egress-proxy + tool-specific routing"
        ],
        "task_category": "documentation",
        "started_at": "2026-01-31T17:03:45.445555Z",
        "completed_at": "2026-01-31T17:06:09.710789Z",
        "actual_hours": 0.04
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    }
  },
  "journal": [
    {
      "timestamp": "2026-01-31T17:03:37.486007Z",
      "entry_type": "status_change",
      "title": "Completed: Document integration constraints",
      "content": "Added integration_model section to spec metadata documenting: api-proxy retention for AI/API keys, gateway+egress-proxy activation only with --isolate-credentials, non-isolated mode unchanged, GH_TOKEN isolation, gh credential helper disablement, and comprehensive proxy routing model.",
      "author": "claude-code",
      "metadata": {},
      "task_id": "task-0-1"
    },
    {
      "timestamp": "2026-01-31T17:03:37.486052Z",
      "entry_type": "status_change",
      "title": "Completed: Add DANGEROUS_PATHS array to validate.sh",
      "content": "Added DANGEROUS_PATHS array to lib/validate.sh with all 13 paths using $HOME expansion for home directories and absolute paths for docker sockets.",
      "author": "claude-code",
      "metadata": {},
      "task_id": "task-1-1"
    },
    {
      "timestamp": "2026-01-31T17:03:37.486081Z",
      "entry_type": "status_change",
      "title": "Completed: Add --allow-dangerous-mount flag",
      "content": "Added --allow-dangerous-mount flag to commands/new.sh with help text documentation and warning output when flag is used.",
      "author": "claude-code",
      "metadata": {},
      "task_id": "task-1-3"
    },
    {
      "timestamp": "2026-01-31T17:06:09.710819Z",
      "entry_type": "status_change",
      "title": "Completed: Document proxy routing design",
      "content": "Added comprehensive proxy_routing_design section documenting traffic splitting (egress-proxy for default, api-proxy for credentialed APIs, gateway for git), NO_PROXY configuration, current state, 5-phase migration path, implementation details, and rollback strategy.",
      "author": "claude-code",
      "metadata": {},
      "task_id": "task-0-2"
    },
    {
      "timestamp": "2026-01-31T17:06:09.710902Z",
      "entry_type": "status_change",
      "title": "Completed: Implement validate_mount_path function",
      "content": "Implemented validate_mount_path function in lib/validate.sh using realpath -m for symlink resolution. Checks exact matches, parent relationships (would expose), and child relationships (inside credentials) with clear error messages.",
      "author": "claude-code",
      "metadata": {},
      "task_id": "task-1-2"
    },
    {
      "timestamp": "2026-01-31T17:06:09.710961Z",
      "entry_type": "status_change",
      "title": "Completed: Integrate mount validation into new.sh",
      "content": "Integrated mount validation into commands/new.sh. Added validation block before mount processing that checks each source path unless --allow-dangerous-mount is set. Exits with code 1 on blocked mounts.",
      "author": "claude-code",
      "metadata": {},
      "task_id": "task-1-4"
    },
    {
      "timestamp": "2026-01-31T17:07:01.649862Z",
      "entry_type": "status_change",
      "title": "Completed: Add unit tests for path validation",
      "content": "Created tests/test_validate.sh with 15 passing tests covering: direct dangerous paths blocked, symlink resolution, docker socket blocked, parent directories blocked, safe paths allowed, paths inside dangerous dirs blocked, and relative path handling.",
      "author": "claude-code",
      "metadata": {},
      "task_id": "task-1-5"
    },
    {
      "timestamp": "2026-01-31T17:08:56.142407Z",
      "entry_type": "status_change",
      "title": "Task Completed: Fidelity review: Integration model clarity",
      "content": "Fidelity review completed. Gemini: PASS - integration_model and proxy_routing_design sections fully capture requirements. Codex had spec accessibility issues (pending vs active path). Phase 0 documentation verified complete.",
      "author": "foundry-mcp",
      "metadata": {},
      "task_id": "verify-0-1"
    }
  ]
}