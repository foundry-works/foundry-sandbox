{
  "spec_id": "credential-isolation-proxy-2026-01-29-001",
  "title": "credential-isolation-proxy",
  "generated": "2026-01-29T11:43:01.021278Z",
  "last_updated": "2026-01-29T11:43:54.850228Z",
  "metadata": {
    "description": "",
    "mission": "Isolate API credentials from sandbox containers using transparent HTTPS interception so AI coding agents can operate autonomously without access to raw API keys.",
    "objectives": [],
    "complexity": "low",
    "estimated_hours": 0,
    "assumptions": [],
    "owner": "",
    "category": "implementation",
    "template": "empty"
  },
  "progress_percentage": 0,
  "status": "pending",
  "current_phase": null,
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "credential-isolation-proxy",
      "status": "pending",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4",
        "phase-5"
      ],
      "total_tasks": 19,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "API Proxy Container",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "task-1-2",
        "task-1-3",
        "verify-1-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Create the mitmproxy-based API proxy that holds credentials and proxies API requests."
      },
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Create API proxy Dockerfile",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "mitmproxy base image with addon and entrypoint",
        "file_path": "api-proxy/Dockerfile",
        "acceptance_criteria": [
          "Dockerfile builds successfully",
          "Based on mitmproxy/mitmproxy image",
          "Copies addon and entrypoint scripts"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-2": {
      "type": "task",
      "title": "Create credential injection addon",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "mitmproxy addon that injects API keys based on host, replaces existing auth headers per Provider Credential Map",
        "file_path": "api-proxy/inject-credentials.py",
        "acceptance_criteria": [
          "Injects correct header per provider domain",
          "Replaces existing auth headers",
          "Non-allowlisted domains pass through unmodified",
          "Returns 500 if env var missing"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-3": {
      "type": "task",
      "title": "Create API proxy entrypoint",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Generates CA cert on first run, starts mitmproxy in transparent mode with healthcheck",
        "file_path": "api-proxy/entrypoint.sh",
        "acceptance_criteria": [
          "Generates CA cert if not exists",
          "Copies CA to shared /certs volume",
          "Starts mitmproxy in transparent mode",
          "Healthcheck endpoint available"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Verify API proxy implementation",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify API proxy implementation matches Provider Credential Map and technical design",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Sandbox Credential Proxy Init",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3",
        "verify-2-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Configure sandbox containers to route API traffic through the api-proxy with proper CA trust."
      },
      "dependencies": {
        "blocks": [
          "phase-3"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "Create credential proxy init script",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Install CA to system trust store, set NODE_EXTRA_CA_CERTS and REQUESTS_CA_BUNDLE env vars, apply iptables REDIRECT rules, block UDP 443",
        "file_path": "safety/credential-proxy-init.sh",
        "acceptance_criteria": [
          "CA installed to /usr/local/share/ca-certificates/",
          "update-ca-certificates called",
          "NODE_EXTRA_CA_CERTS set",
          "REQUESTS_CA_BUNDLE set",
          "iptables REDIRECT rule for port 443",
          "UDP 443 blocked"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "Add init script to Dockerfile",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Copy credential-proxy-init.sh to /usr/local/bin/ and make executable",
        "file_path": "Dockerfile",
        "acceptance_criteria": [
          "Script copied to /usr/local/bin/",
          "Script is executable"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "Integrate init into entrypoint",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Call credential-proxy-init.sh when CREDENTIAL_ISOLATION=1",
        "file_path": "entrypoint.sh",
        "acceptance_criteria": [
          "Checks CREDENTIAL_ISOLATION env var",
          "Calls init script with sudo if enabled",
          "Continues normally if disabled"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Verify sandbox init implementation",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify init script covers CA Trust section requirements and iptables rules match technical design",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Docker Compose Integration",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "verify-3-1"
      ],
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Wire up api-proxy and sandbox with networking, volumes, and startup sequencing."
      },
      "dependencies": {
        "blocks": [
          "phase-4"
        ],
        "blocked_by": [
          "phase-2"
        ],
        "depends": []
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "Create credential isolation compose override",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "API proxy service with API keys, isolated network, shared cert volume, healthcheck-based depends_on. Dev service overrides to clear API keys and set CREDENTIAL_ISOLATION=1",
        "file_path": "docker-compose.credential-isolation.yml",
        "acceptance_criteria": [
          "API proxy service defined with all API key env vars",
          "Isolated network with static API proxy IP",
          "Shared mitm-certs volume",
          "API proxy has healthcheck",
          "Dev depends_on api-proxy with condition: service_healthy",
          "Dev has CREDENTIAL_ISOLATION=1",
          "Dev has empty API key vars"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Verify compose integration",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify compose file matches Startup Sequence in technical design",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "CLI Integration",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-4-1",
        "task-4-2",
        "task-4-3",
        "verify-4-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Add --isolate-credentials flag to sandbox creation command."
      },
      "dependencies": {
        "blocks": [
          "phase-5"
        ],
        "blocked_by": [
          "phase-3"
        ],
        "depends": []
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "Add isolate-credentials flag parsing",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Parse --isolate-credentials and --isolate flags, set NEW_ISOLATE_CREDENTIALS variable",
        "file_path": "lib/args.sh",
        "acceptance_criteria": [
          "--isolate-credentials flag parsed",
          "--isolate alias works",
          "NEW_ISOLATE_CREDENTIALS set to true when flag present"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-2": {
      "type": "task",
      "title": "Apply isolation compose override",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Include docker-compose.credential-isolation.yml when --isolate-credentials flag is set",
        "file_path": "commands/new.sh",
        "acceptance_criteria": [
          "Compose override added when flag set",
          "Normal flow unchanged when flag absent"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-3": {
      "type": "task",
      "title": "Update help text",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add --isolate-credentials flag to help output",
        "file_path": "commands/help.sh",
        "acceptance_criteria": [
          "Flag documented in help",
          "Description explains credential isolation"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Verify CLI integration",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify CLI integration is complete and help text accurate",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-5": {
      "type": "phase",
      "title": "End-to-End Testing",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-5-1",
        "task-5-2",
        "task-5-3",
        "task-5-4",
        "verify-5-1"
      ],
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Validate AI CLI tools work through proxy."
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-4"
        ],
        "depends": []
      }
    },
    "task-5-1": {
      "type": "task",
      "title": "Test claude CLI through proxy",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify claude CLI works with streaming responses through the proxy",
        "acceptance_criteria": [
          "claude command returns valid response",
          "Streaming works correctly",
          "API proxy logs show credential injection"
        ],
        "task_category": "investigation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-5-2": {
      "type": "task",
      "title": "Test codex CLI through proxy",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify codex CLI works through the proxy",
        "acceptance_criteria": [
          "codex command returns valid response",
          "API proxy logs show credential injection"
        ],
        "task_category": "investigation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-5-3": {
      "type": "task",
      "title": "Test curl and Python through proxy",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify curl and Python requests library work through proxy without cert errors",
        "acceptance_criteria": [
          "curl https://api.anthropic.com works",
          "Python requests works",
          "No certificate errors"
        ],
        "task_category": "investigation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-5-4": {
      "type": "task",
      "title": "Verify credential isolation",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Confirm API keys are not present in sandbox environment",
        "acceptance_criteria": [
          "env | grep API_KEY returns empty",
          "API proxy container has API keys",
          "Sandbox cannot access raw credentials"
        ],
        "task_category": "investigation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-5-1": {
      "type": "verify",
      "title": "Verify all success criteria met",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Final fidelity review confirming all success criteria are satisfied",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    }
  },
  "journal": []
}
