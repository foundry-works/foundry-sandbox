{
  "spec_id": "unified-proxy-consolidation-2026-02-04-001",
  "title": "unified-proxy-consolidation",
  "generated": "2026-02-04T21:40:33.467740Z",
  "last_updated": "2026-02-04T22:20:13.997762Z",
  "metadata": {
    "description": "",
    "mission": "Consolidate gateway and api-proxy into a single mitmproxy-based service handling all external traffic (git, API, DNS), replacing session tokens with container identity",
    "objectives": [],
    "complexity": "low",
    "estimated_hours": 0,
    "assumptions": [
      "Docker container IDs are cryptographically random (64-char hex)",
      "Source IP spoofing is not possible within Docker network namespace",
      "mitmproxy 11+ is available with stable DNS mode",
      "GitHub branch protection is configured for repos needing force-push prevention",
      "Unix domain socket access is controlled by filesystem permissions",
      "Max 50 concurrent sandboxes (for capacity planning)",
      "Average sandbox lifetime: 1-8 hours",
      "Docker API is accessible from proxy container for orphan cleanup",
      "[SUPERSEDES a-7] No registration TTL - sandboxes run indefinitely until explicitly stopped; orphan cleanup via Docker API on startup"
    ],
    "owner": "",
    "category": "implementation",
    "template": "empty"
  },
  "progress_percentage": 0,
  "status": "pending",
  "current_phase": null,
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "unified-proxy-consolidation",
      "status": "pending",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4",
        "phase-5",
        "phase-6",
        "phase-7"
      ],
      "total_tasks": 64,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Infrastructure Setup",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "task-1-2",
        "task-1-3",
        "task-1-4",
        "task-1-5",
        "task-1-6",
        "task-1-7",
        "task-1-8",
        "verify-1-1"
      ],
      "total_tasks": 9,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Set up test infrastructure and document key decisions before implementation"
      },
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Create test directory structure",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create tests/unit/, tests/integration/, tests/security/, tests/performance/ directories with appropriate README files",
        "file_path": "tests/unit/.gitkeep",
        "acceptance_criteria": [
          "tests/unit/ directory exists",
          "tests/integration/ directory exists",
          "tests/security/ directory exists",
          "tests/performance/ directory exists"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-2": {
      "type": "task",
      "title": "Create docker-compose.test.yml",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create Docker Compose file for test infrastructure with unified-proxy and test-sandbox services",
        "file_path": "tests/docker-compose.test.yml",
        "acceptance_criteria": [
          "docker-compose -f tests/docker-compose.test.yml config validates successfully",
          "unified-proxy service defined with health check",
          "test-sandbox service defined with proxy environment variables"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-3": {
      "type": "task",
      "title": "Write ADR-000: Template",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create ADR template document",
        "file_path": "docs/adr/000-template.md",
        "acceptance_criteria": [
          "Template includes Status, Context, Decision, Consequences sections"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-4": {
      "type": "task",
      "title": "Write ADR-001: Consolidation",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Document decision to consolidate gateway and api-proxy into unified-proxy",
        "file_path": "docs/adr/001-consolidation.md",
        "acceptance_criteria": [
          "Documents current architecture problems",
          "Documents proposed architecture",
          "Lists consequences and trade-offs"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-5": {
      "type": "task",
      "title": "Write ADR-002: Container Identity",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Document container identity design including IP binding, TTL, renewal",
        "file_path": "docs/adr/002-container-identity.md",
        "acceptance_criteria": [
          "Documents IP-based identity model",
          "Documents optional header validation",
          "Documents registration lifecycle"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-6": {
      "type": "task",
      "title": "Write ADR-003: Policy Engine",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Document policy engine design with evaluation order, precedence, fail-closed behavior",
        "file_path": "docs/adr/003-policy-engine.md",
        "acceptance_criteria": [
          "Documents default deny model",
          "Documents evaluation order",
          "Documents rule precedence and conflict resolution"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-7": {
      "type": "task",
      "title": "Write ADR-004: DNS Integration",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Document DNS integration decision including topology and fallback path",
        "file_path": "docs/adr/004-dns-integration.md",
        "acceptance_criteria": [
          "Documents dual-mode architecture",
          "Documents DNS go/no-go criteria",
          "Documents fallback to dnsmasq"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-8": {
      "type": "task",
      "title": "Write ADR-005: Failure Modes",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Document failure modes and readiness design",
        "file_path": "docs/adr/005-failure-modes.md",
        "acceptance_criteria": [
          "Documents fail-closed behavior",
          "Documents readiness probe checks",
          "Documents startup sequence",
          "Documents graceful shutdown"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Verify Phase 0 completion",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify all infrastructure setup tasks are complete",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Container Identity",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3",
        "task-2-4",
        "task-2-5",
        "task-2-6",
        "task-2-7",
        "verify-2-1"
      ],
      "total_tasks": 8,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Replace session tokens with container IP + container_id identity, persisted in SQLite"
      },
      "dependencies": {
        "blocks": [
          "phase-3"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "Create registry.py with SQLite persistence",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create SQLite persistence layer with WAL mode, busy_timeout=5000, synchronous=NORMAL, write-through cache with immediate invalidation, RLock for cache access",
        "file_path": "unified-proxy/registry.py",
        "acceptance_criteria": [
          "WAL mode enabled",
          "busy_timeout=5000 configured",
          "Write-through cache implemented",
          "RLock protects cache access",
          "get_by_ip() returns ContainerConfig or None",
          "register() persists and refreshes cache",
          "unregister() removes and refreshes cache"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "Create container_identity.py addon",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create mitmproxy addon for container identity based on source IP lookup with optional X-Container-Id header validation",
        "file_path": "unified-proxy/addons/container_identity.py",
        "acceptance_criteria": [
          "Identifies container by source IP",
          "Validates X-Container-Id header if present",
          "Strips X-Container-Id header before forwarding",
          "Attaches container config to flow.metadata",
          "Returns 403 for unknown source IP",
          "Returns 403 for mismatched header",
          "Returns 403 for expired registration"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "Create internal_api.py for registration",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create Flask API for container registration exposed via Unix socket with rate limiting",
        "file_path": "unified-proxy/internal_api.py",
        "acceptance_criteria": [
          "POST /internal/containers registers container",
          "DELETE /internal/containers/{id} unregisters container",
          "GET /internal/health returns health status",
          "Rate limited to 10 req/sec",
          "Binds to Unix socket only"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-4": {
      "type": "task",
      "title": "Create logging_config.py",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create structured JSON logging configuration with correlation ID support",
        "file_path": "unified-proxy/logging_config.py",
        "acceptance_criteria": [
          "JSON log format configured",
          "request_id field supported",
          "container_id field supported",
          "Log levels configurable"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-5": {
      "type": "task",
      "title": "Create test_container_identity.py",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for container identity addon",
        "file_path": "tests/unit/test_container_identity.py",
        "acceptance_criteria": [
          "Tests unknown source IP returns 403",
          "Tests mismatched header returns 403",
          "Tests expired registration returns 403",
          "Tests valid registration proceeds",
          "Tests header stripped before forwarding"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-6": {
      "type": "task",
      "title": "Create test_registry.py with stress tests",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for registry including concurrency and stress tests",
        "file_path": "tests/unit/test_registry.py",
        "acceptance_criteria": [
          "Tests basic CRUD operations",
          "Tests cache consistency",
          "Tests concurrent reads",
          "Stress test: 100 concurrent lookups + 10 writes/sec"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-7": {
      "type": "task",
      "title": "Create lib/proxy.sh",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create shell functions for proxy interaction with retry/backoff logic",
        "file_path": "lib/proxy.sh",
        "acceptance_criteria": [
          "proxy_register() function implemented",
          "proxy_unregister() function implemented",
          "proxy_wait_ready() with exponential backoff",
          "30 second timeout on startup"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Verify Phase 1 completion",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify container identity system works correctly",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Policy Engine",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3",
        "task-3-4",
        "task-3-5",
        "task-3-6",
        "task-3-7",
        "task-3-8",
        "task-3-9",
        "task-3-10",
        "task-3-11",
        "task-3-12",
        "verify-3-1"
      ],
      "total_tasks": 13,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Centralized policy checks for all traffic (DNS + HTTP)"
      },
      "dependencies": {
        "blocks": [
          "phase-4"
        ],
        "blocked_by": [
          "phase-2"
        ],
        "depends": []
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "Create policy_engine.py addon",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create centralized policy enforcement addon with default deny, documented evaluation order, and policy decision logging",
        "file_path": "unified-proxy/addons/policy_engine.py",
        "acceptance_criteria": [
          "Default deny implemented",
          "Evaluation order: identity -> allowlist -> blocklist -> rate limit -> circuit breaker",
          "Logs allow/deny with reason for every request",
          "Blocks PUT /repos/x/y/pulls/N/merge",
          "Blocks POST /repos/x/y/releases"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "Create dns_filter.py addon",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create DNS query filtering addon using shared PolicyEngine allowlist",
        "file_path": "unified-proxy/addons/dns_filter.py",
        "acceptance_criteria": [
          "Identifies container by source IP",
          "Checks domain against allowlist",
          "Returns NXDOMAIN for blocked domains",
          "Logs DNS queries with query_type, query_name, response"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-3": {
      "type": "task",
      "title": "Create circuit_breaker.py addon",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create per-upstream circuit breaker addon",
        "file_path": "unified-proxy/addons/circuit_breaker.py",
        "acceptance_criteria": [
          "Configurable failure threshold",
          "Configurable recovery timeout",
          "Opens circuit on consecutive failures",
          "Half-open state allows probe requests",
          "Closes circuit on successful probes"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-4": {
      "type": "task",
      "title": "Create rate_limiter.py addon",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create per-container, per-upstream rate limiting addon using token bucket",
        "file_path": "unified-proxy/addons/rate_limiter.py",
        "acceptance_criteria": [
          "Token bucket algorithm implemented",
          "Per-container limits",
          "Per-upstream limits",
          "Returns 429 on limit exceeded",
          "Periodic cleanup of stale buckets"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-5": {
      "type": "task",
      "title": "Create config.py loader",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unified config loader with validation for policy.yaml and allowlist.yaml",
        "file_path": "unified-proxy/config.py",
        "acceptance_criteria": [
          "Loads policy.yaml",
          "Loads allowlist.yaml",
          "Validates required fields",
          "Fails fast on invalid config"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-6": {
      "type": "task",
      "title": "Create allowlist.yaml",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unified domain allowlist for DNS and HTTP",
        "file_path": "config/allowlist.yaml",
        "acceptance_criteria": [
          "GitHub domains included",
          "AI provider domains included",
          "Package repository domains included",
          "Wildcard patterns supported"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-7": {
      "type": "task",
      "title": "Create policy.yaml.example",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create example policy configuration",
        "file_path": "config/policy.yaml.example",
        "acceptance_criteria": [
          "Documents all policy options",
          "Includes blocked API patterns",
          "Includes circuit breaker config",
          "Includes rate limit config"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-8": {
      "type": "task",
      "title": "Create test_policy_engine.py",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for policy engine including precedence and conflict tests",
        "file_path": "tests/unit/test_policy_engine.py",
        "acceptance_criteria": [
          "Tests default deny",
          "Tests allowlist matching",
          "Tests blocklist override",
          "Tests evaluation order",
          "Tests conflict resolution"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-9": {
      "type": "task",
      "title": "Create test_dns_filter.py",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for DNS filter",
        "file_path": "tests/unit/test_dns_filter.py",
        "acceptance_criteria": [
          "Tests allowlisted domain resolves",
          "Tests blocked domain returns NXDOMAIN",
          "Tests container identification by IP"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-10": {
      "type": "task",
      "title": "Create test_rate_limiter.py",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for rate limiter",
        "file_path": "tests/unit/test_rate_limiter.py",
        "acceptance_criteria": [
          "Tests token bucket refill",
          "Tests burst handling",
          "Tests 429 on limit exceeded",
          "Tests per-container isolation"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-11": {
      "type": "task",
      "title": "Create test_circuit_breaker.py",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for circuit breaker",
        "file_path": "tests/unit/test_circuit_breaker.py",
        "acceptance_criteria": [
          "Tests circuit opens on failures",
          "Tests half-open state",
          "Tests circuit closes on success",
          "Tests per-upstream isolation"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-12": {
      "type": "task",
      "title": "DNS go/no-go validation",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Test mitmproxy DNS mode against go/no-go criteria: handles A/AAAA/CNAME correctly, filtering works, p99 latency < 50ms. If criteria not met, activate dnsmasq fallback path.",
        "acceptance_criteria": [
          "DNS mode handles A, AAAA, CNAME queries",
          "DNS filtering rejects non-allowlisted domains",
          "DNS p99 latency < 50ms under load",
          "OR fallback to dnsmasq documented and ready"
        ],
        "task_category": "investigation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Verify Phase 2 completion",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify policy engine and DNS integration work correctly",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Git Proxy",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-4-1",
        "task-4-2",
        "task-4-3",
        "task-4-4",
        "task-4-5",
        "verify-4-1"
      ],
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Handle git operations in mitmproxy with policy enforcement"
      },
      "dependencies": {
        "blocks": [
          "phase-5"
        ],
        "blocked_by": [
          "phase-3"
        ],
        "depends": []
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "Create pktline.py parser",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Port git pkt-line parser from gateway, supporting push ref parsing and deletion detection",
        "file_path": "unified-proxy/pktline.py",
        "acceptance_criteria": [
          "Parses pkt-line format correctly",
          "Extracts old_sha, new_sha, refname from push",
          "Detects branch deletion (new_sha = 0000...)",
          "Handles edge cases (empty lines, flush packets)"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-2": {
      "type": "task",
      "title": "Create git_proxy.py addon",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create git protocol handling addon with repo authorization, branch deletion blocking, and auth mode restrictions",
        "file_path": "unified-proxy/addons/git_proxy.py",
        "acceptance_criteria": [
          "Identifies git requests by path pattern",
          "Checks repo authorization against container.repos",
          "Blocks branch deletion",
          "Bot mode: restricts push to sandbox/* branches",
          "Enforces push size limits with 413 response",
          "Logs git operations with repo, refs, push_size_bytes"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-3": {
      "type": "task",
      "title": "Create test_git_proxy.py",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for git proxy addon",
        "file_path": "tests/unit/test_git_proxy.py",
        "acceptance_criteria": [
          "Tests clone authorized repo succeeds",
          "Tests clone unauthorized repo returns 403",
          "Tests branch deletion returns 403",
          "Tests bot mode push to main returns 403",
          "Tests bot mode push to sandbox/* succeeds",
          "Tests push size limit returns 413"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-4": {
      "type": "task",
      "title": "Create test_pktline.py",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for pkt-line parser",
        "file_path": "tests/unit/test_pktline.py",
        "acceptance_criteria": [
          "Tests basic pkt-line parsing",
          "Tests deletion detection",
          "Tests multi-ref push parsing",
          "Tests edge cases"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-5": {
      "type": "task",
      "title": "Create test_git_policy.py security tests",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create security tests for git operations",
        "file_path": "tests/security/test_git_policy.py",
        "acceptance_criteria": [
          "Tests unauthorized repo access blocked",
          "Tests branch deletion blocked",
          "Tests auth mode enforcement",
          "Tests push size limits"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Verify Phase 3 completion",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify git proxy works correctly with all policy enforcement",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-5": {
      "type": "phase",
      "title": "Credential Injection Refactor",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-5-1",
        "task-5-2",
        "task-5-3",
        "task-5-4",
        "verify-5-1"
      ],
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Integrate existing credential injection with new architecture"
      },
      "dependencies": {
        "blocks": [
          "phase-6"
        ],
        "blocked_by": [
          "phase-4"
        ],
        "depends": []
      }
    },
    "task-5-1": {
      "type": "task",
      "title": "Refactor credential_injector.py",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Refactor inject-credentials.py into mitmproxy addon using flow.metadata['container'] for per-container rules",
        "file_path": "unified-proxy/addons/credential_injector.py",
        "acceptance_criteria": [
          "Injects credentials for allowlisted APIs",
          "Uses flow.metadata['container'] for context",
          "Supports GitHub token injection for git and API",
          "Handles OAuth token refresh"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-5-2": {
      "type": "task",
      "title": "Move OAuth managers",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Move OAuth token managers to unified-proxy/addons/oauth_managers/",
        "file_path": "unified-proxy/addons/oauth_managers/__init__.py",
        "acceptance_criteria": [
          "codex.py moved",
          "gemini.py moved",
          "opencode.py moved",
          "Imports updated"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-5-3": {
      "type": "task",
      "title": "Create metrics.py addon",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create Prometheus metrics addon with request counters, latency histograms, DNS counters, and state gauges",
        "file_path": "unified-proxy/addons/metrics.py",
        "acceptance_criteria": [
          "Request counters by container, upstream, status",
          "Latency histograms for HTTP and DNS",
          "DNS query counters",
          "Rate limit/circuit breaker state gauges",
          "GET /internal/metrics returns Prometheus format"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-5-4": {
      "type": "task",
      "title": "Create test_credential_injector.py",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create unit tests for credential injector addon",
        "file_path": "tests/unit/test_credential_injector.py",
        "acceptance_criteria": [
          "Tests API credential injection",
          "Tests GitHub token injection for git",
          "Tests OAuth refresh flow",
          "Tests credential injection latency p99 < 10ms"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-5-1": {
      "type": "verify",
      "title": "Verify Phase 4 completion",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify credential injection and metrics work correctly",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-6": {
      "type": "phase",
      "title": "Infrastructure Changes",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-6-1",
        "task-6-2",
        "task-6-3",
        "task-6-4",
        "task-6-5",
        "task-6-6",
        "task-6-7",
        "task-6-8",
        "task-6-9",
        "task-6-10",
        "task-6-11",
        "task-6-12",
        "verify-6-1"
      ],
      "total_tasks": 13,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Update Docker setup, finalize integration, validate end-to-end"
      },
      "dependencies": {
        "blocks": [
          "phase-7"
        ],
        "blocked_by": [
          "phase-5"
        ],
        "depends": []
      }
    },
    "task-6-1": {
      "type": "task",
      "title": "Rename api-proxy to unified-proxy",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Rename api-proxy/ directory to unified-proxy/",
        "file_path": "unified-proxy/",
        "acceptance_criteria": [
          "Directory renamed",
          "All internal imports updated",
          "No broken references"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-2": {
      "type": "task",
      "title": "Create/update Dockerfile",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create or update Dockerfile for unified-proxy with mitmproxy, Python dependencies, and proper configuration",
        "file_path": "unified-proxy/Dockerfile",
        "acceptance_criteria": [
          "Based on Python 3.11+ image",
          "Installs mitmproxy 11+",
          "Installs Python dependencies",
          "Copies addon files",
          "Sets up volumes for config and socket"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-3": {
      "type": "task",
      "title": "Create entrypoint.sh",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create entrypoint script with dual-mode startup (HTTP + DNS), config validation, readiness probe, and graceful shutdown",
        "file_path": "unified-proxy/entrypoint.sh",
        "acceptance_criteria": [
          "Validates config before startup",
          "Starts mitmproxy with --mode regular@8080 --mode dns@53",
          "Loads all addons in correct order",
          "Handles SIGTERM gracefully",
          "Exposes readiness check"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-4": {
      "type": "task",
      "title": "Create requirements.txt",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create Python requirements file with all dependencies",
        "file_path": "unified-proxy/requirements.txt",
        "acceptance_criteria": [
          "mitmproxy>=11.0.0",
          "flask",
          "pyyaml",
          "prometheus_client",
          "All OAuth manager dependencies"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-5": {
      "type": "task",
      "title": "Update docker-compose.credential-isolation.yml",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update Docker Compose to remove gateway service and configure unified-proxy",
        "file_path": "docker-compose.credential-isolation.yml",
        "acceptance_criteria": [
          "Gateway service removed",
          "unified-proxy service configured",
          "Health check defined",
          "Volumes for socket, config, and data",
          "Sandbox DNS points to unified-proxy:53"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-6": {
      "type": "task",
      "title": "Finalize lib/proxy.sh",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Finalize proxy.sh with full registration lifecycle, retry/backoff, and 30s timeout",
        "file_path": "lib/proxy.sh",
        "acceptance_criteria": [
          "proxy_register() handles full lifecycle",
          "proxy_unregister() cleans up on sandbox stop",
          "proxy_wait_ready() with exponential backoff",
          "30 second timeout before failing sandbox start"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-7": {
      "type": "task",
      "title": "Create test_git_operations.py integration test",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create integration tests for git operations through proxy",
        "file_path": "tests/integration/test_git_operations.py",
        "acceptance_criteria": [
          "Tests git clone through proxy",
          "Tests git push through proxy",
          "Tests branch deletion blocked",
          "Tests auth mode enforcement"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-8": {
      "type": "task",
      "title": "Create test_api_proxy.py integration test",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create integration tests for API proxying",
        "file_path": "tests/integration/test_api_proxy.py",
        "acceptance_criteria": [
          "Tests API calls get credentials injected",
          "Tests blocked API endpoints return 403",
          "Tests rate limiting",
          "Tests circuit breaker"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-9": {
      "type": "task",
      "title": "Create test_container_lifecycle.py integration test",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create integration tests for container lifecycle including restart scenarios",
        "file_path": "tests/integration/test_container_lifecycle.py",
        "acceptance_criteria": [
          "Tests container registration",
          "Tests container unregistration",
          "Tests proxy restart preserves registrations",
          "Tests sandbox reconnects after proxy restart"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-10": {
      "type": "task",
      "title": "Update redteam-sandbox.sh",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update security red-team tests for new architecture",
        "file_path": "tests/security/redteam-sandbox.sh",
        "acceptance_criteria": [
          "Tests updated for unified-proxy",
          "Tests registration API isolation",
          "Tests policy bypass attempts",
          "Tests container isolation"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-11": {
      "type": "task",
      "title": "Create test_latency.py performance test",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create performance tests to validate latency budgets",
        "file_path": "tests/performance/test_latency.py",
        "acceptance_criteria": [
          "Tests HTTP passthrough p99 < 50ms",
          "Tests credential injection p99 < 10ms",
          "Tests DNS resolution p99 < 50ms",
          "Tests registry lookup p99 < 1ms"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-6-12": {
      "type": "task",
      "title": "Create test_throughput.py performance test",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create performance tests to validate capacity targets",
        "file_path": "tests/performance/test_throughput.py",
        "acceptance_criteria": [
          "Tests 1000 req/sec HTTP throughput",
          "Tests 500 qps DNS throughput",
          "Tests 50 concurrent containers",
          "Tests 10 registrations/minute"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-6-1": {
      "type": "verify",
      "title": "Verify Phase 5 completion",
      "status": "pending",
      "parent": "phase-6",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify end-to-end integration works correctly with all tests passing",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-7": {
      "type": "phase",
      "title": "Cleanup & Documentation",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-7-1",
        "task-7-2",
        "task-7-3",
        "task-7-4",
        "task-7-5",
        "task-7-6",
        "task-7-7",
        "task-7-8",
        "task-7-9",
        "verify-7-1"
      ],
      "total_tasks": 10,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Remove old code, update documentation, finalize migration"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-6"
        ],
        "depends": []
      }
    },
    "task-7-1": {
      "type": "task",
      "title": "Delete gateway/ directory",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Delete the entire gateway/ directory",
        "file_path": "gateway/",
        "acceptance_criteria": [
          "gateway/ directory removed",
          "No references to gateway in codebase"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-2": {
      "type": "task",
      "title": "Delete lib/gateway.sh",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Delete the old gateway.sh library file",
        "file_path": "lib/gateway.sh",
        "acceptance_criteria": [
          "lib/gateway.sh removed",
          "No scripts sourcing gateway.sh"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-3": {
      "type": "task",
      "title": "Update docs/architecture.md",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update architecture documentation to reflect new unified-proxy architecture",
        "file_path": "docs/architecture.md",
        "acceptance_criteria": [
          "Documents unified-proxy architecture",
          "Removes references to gateway",
          "Includes architecture diagrams",
          "Documents addon structure"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-4": {
      "type": "task",
      "title": "Finalize ADRs",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Finalize ADR-001 through ADR-005 with implementation outcomes",
        "file_path": "docs/adr/001-consolidation.md",
        "acceptance_criteria": [
          "ADR-001 status updated",
          "ADR-002 status updated",
          "ADR-003 status updated",
          "ADR-004 status updated",
          "ADR-005 status updated"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-5": {
      "type": "task",
      "title": "Create docs/certificates.md",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create certificate management guide",
        "file_path": "docs/certificates.md",
        "acceptance_criteria": [
          "Documents CA certificate generation",
          "Documents certificate distribution to sandboxes",
          "Documents certificate rotation procedure"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-6": {
      "type": "task",
      "title": "Create docs/observability.md",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create metrics, logging, and alerting guide",
        "file_path": "docs/observability.md",
        "acceptance_criteria": [
          "Documents all Prometheus metrics",
          "Documents structured log format",
          "Documents recommended alerts",
          "Documents debugging workflows"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-7": {
      "type": "task",
      "title": "Create docs/operations.md",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create operations runbook for common operations and incidents",
        "file_path": "docs/operations.md",
        "acceptance_criteria": [
          "Documents proxy restart procedure",
          "Documents SQLite recovery procedure",
          "Documents DNS fallback activation",
          "Documents troubleshooting steps"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-8": {
      "type": "task",
      "title": "Update tests/README.md",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update test documentation with test matrices",
        "file_path": "tests/README.md",
        "acceptance_criteria": [
          "Documents unit test structure",
          "Documents integration test structure",
          "Documents security test structure",
          "Documents performance test targets"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-7-9": {
      "type": "task",
      "title": "Archive PLAN.md",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Archive or delete PLAN.md after migration is complete",
        "file_path": "PLAN.md",
        "acceptance_criteria": [
          "PLAN.md archived to docs/archive/ or deleted"
        ],
        "task_category": "refactoring"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-7-1": {
      "type": "verify",
      "title": "Final verification",
      "status": "pending",
      "parent": "phase-7",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify all tests pass, documentation is complete, and no references to old gateway service remain",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    }
  },
  "journal": []
}