# credential-isolation-proxy

## Mission

Isolate API credentials from sandbox containers using transparent HTTPS interception so AI coding agents can operate autonomously without access to raw API keys.

## Objective

Enable true credential isolation where API keys never enter sandbox containers. A mitmproxy-based gateway intercepts HTTPS traffic to AI provider domains, injects real credentials, and forwards requests upstream. CLI tools (claude, codex, gemini, cursor-agent) work unmodified because interception happens at the network level.

## Scope

### In Scope
- Gateway container running mitmproxy with credential injection addon
- Sandbox init script for iptables REDIRECT and CA trust
- Docker Compose override for credential isolation mode
- CLI flag `--isolate-credentials` for sandbox creation
- Support for major AI providers: Anthropic, OpenAI, Google, Groq, Mistral, DeepSeek, Together, OpenRouter, Fireworks
- CA trust for system store + Node.js + Python
- SSE streaming support (mitmproxy handles this natively)

### Out of Scope (YAGNI)
- JWT session management
- Per-provider access scopes
- Audit logging
- Rate limiting
- HTTP/3 / QUIC support (block UDP 443 to force TCP fallback)

## Technical Design

### Traffic Interception

Use iptables `REDIRECT` to capture outbound port 443 traffic. mitmproxy in transparent mode uses `SO_ORIGINAL_DST` to recover the original destination and SNI for TLS routing:

```bash
# Capture all outbound 443 traffic
iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-port 8080

# Block QUIC/HTTP3 to force TCP fallback
iptables -A OUTPUT -p udp --dport 443 -j DROP
```

### CA Trust

CA cert is generated by gateway on first start, written to shared volume `/certs/mitmproxy-ca.pem`.

Sandbox init installs it:
- System: `cp` to `/usr/local/share/ca-certificates/` + `update-ca-certificates`
- Node.js: `NODE_EXTRA_CA_CERTS=/certs/mitmproxy-ca.pem`
- Python: `REQUESTS_CA_BUNDLE=/certs/mitmproxy-ca.pem`

### Provider Credential Map

| Domain | Header | Env Var | Format |
|--------|--------|---------|--------|
| api.anthropic.com | x-api-key | ANTHROPIC_API_KEY | value |
| api.openai.com | Authorization | OPENAI_API_KEY | Bearer {value} |
| generativelanguage.googleapis.com | x-goog-api-key | GOOGLE_API_KEY | value |
| api.groq.com | Authorization | GROQ_API_KEY | Bearer {value} |
| api.mistral.ai | Authorization | MISTRAL_API_KEY | Bearer {value} |
| api.deepseek.com | Authorization | DEEPSEEK_API_KEY | Bearer {value} |
| api.together.xyz | Authorization | TOGETHER_API_KEY | Bearer {value} |
| openrouter.ai | Authorization | OPENROUTER_API_KEY | Bearer {value} |
| api.fireworks.ai | Authorization | FIREWORKS_API_KEY | Bearer {value} |

Credential injection replaces any existing auth header. Non-allowlisted domains pass through unmodified.

### Startup Sequence

1. Gateway starts, generates CA cert, writes to shared volume, starts healthcheck
2. Sandbox waits (depends_on: condition: service_healthy)
3. Sandbox init installs CA, applies iptables rules
4. Sandbox entrypoint continues

## Phases

### Phase 1: Gateway Container

**Purpose**: Create the mitmproxy-based gateway that holds credentials and proxies API requests.

**Tasks**:
1. Create `gateway/Dockerfile` - mitmproxy base image with addon and entrypoint
2. Create `gateway/inject-credentials.py` - mitmproxy addon that injects API keys based on host, replaces existing auth headers
3. Create `gateway/entrypoint.sh` - generates CA cert, starts mitmproxy in transparent mode with healthcheck

**Verification**:
- Gateway container builds successfully
- mitmproxy starts without errors
- CA certificate generated and accessible
- Healthcheck returns 200

**Fidelity Review**: Verify gateway implementation matches Provider Credential Map

### Phase 2: Sandbox Credential Proxy Init

**Purpose**: Configure sandbox containers to route API traffic through the gateway with proper CA trust.

**Tasks**:
1. Create `safety/credential-proxy-init.sh` - install CA to system + set env vars + apply iptables rules
2. Modify `Dockerfile` to copy init script
3. Modify `entrypoint.sh` to call init script when `CREDENTIAL_ISOLATION=1`

**Verification**:
- CA installed to system trust store
- iptables rules redirect 443 traffic
- UDP 443 blocked
- `curl https://api.anthropic.com` goes through gateway

**Fidelity Review**: Verify init script covers CA Trust section requirements

### Phase 3: Docker Compose Integration

**Purpose**: Wire up gateway and sandbox with networking, volumes, and startup sequencing.

**Tasks**:
1. Create `docker-compose.credential-isolation.yml` with gateway service, isolated network, shared cert volume, healthcheck-based depends_on
2. Dev service overrides to clear API keys and set CREDENTIAL_ISOLATION=1

**Verification**:
- Both containers start with `docker-compose up`
- Sandbox waits for gateway healthcheck
- Gateway has API keys, sandbox does not

**Fidelity Review**: Verify compose matches Startup Sequence

### Phase 4: CLI Integration

**Purpose**: Add `--isolate-credentials` flag to sandbox creation.

**Tasks**:
1. Modify `lib/args.sh` to parse `--isolate-credentials` / `--isolate`
2. Modify `commands/new.sh` to include override when flag set
3. Update help text

**Verification**:
- `./sandbox.sh new repo branch --isolate-credentials` works
- Without flag works as before
- Help shows new flag

**Fidelity Review**: Verify CLI integration complete

### Phase 5: End-to-End Testing

**Purpose**: Validate AI CLI tools work through proxy.

**Tasks**:
1. Test claude CLI (streaming)
2. Test codex CLI
3. Test curl and Python requests
4. Verify no API keys in sandbox env

**Verification**:
- `env | grep API_KEY` returns empty
- `claude "hello"` works
- `curl https://api.anthropic.com` works
- Gateway logs show credential injection

**Fidelity Review**: All success criteria met

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| CA not trusted by runtime | High | Cover system + Node + Python explicitly |
| QUIC bypasses proxy | High | Block UDP 443 |
| Gateway not ready at start | High | healthcheck + depends_on |
| Latency overhead | Low | ~50ms acceptable |

## Success Criteria

- [ ] API keys NOT in sandbox environment
- [ ] Claude CLI works with streaming
- [ ] Codex CLI works
- [ ] curl works (no cert errors)
- [ ] Gateway logs show injection for allowlisted domains
- [ ] Existing sandbox creation unaffected
