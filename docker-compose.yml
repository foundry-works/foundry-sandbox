services:
  dev:
    build:
      context: .
      args:
        UID: ${DOCKER_UID:-1000}
        GID: ${DOCKER_GID:-1000}
    image: foundry-sandbox

    # Layer 0: Read-only root filesystem (primary security boundary)
    # Prevents rm -rf / even via /bin/rm bypass
    read_only: true

    volumes:
      # Workspace (set by sandbox.sh via WORKSPACE_PATH)
      - ${WORKSPACE_PATH:-.}:/workspace
      # foundry-mcp errors and metrics (shared across all sandboxes)
      - ${HOME}/.foundry-mcp:/home/ubuntu/.foundry-mcp
      # Bikelane project directory
      - ${HOME}/GitHub/_bikelane:/home/ubuntu/bikelane

    # Writable tmpfs mounts (RAM-backed, cleared on container stop)
    tmpfs:
      - /tmp:exec,mode=1777,size=512m
      - /var/tmp:mode=1777,size=256m
      - /run:mode=755,size=64m
      - /var/cache/apt:mode=755,size=256m
      - /var/lib/apt/lists:mode=755,size=128m
      # Home directory - writable for configs, caches, local packages
      # Use a named volume instead if you need persistence across restarts
      - /home/ubuntu:mode=755,uid=1000,gid=1000,size=1g

    # Interactive shell
    stdin_open: true
    tty: true

    working_dir: /workspace

    # Restart on reboot unless explicitly stopped
    restart: unless-stopped

    environment:
      # Host username for path compatibility
      - HOST_USER=${HOST_USER:-}
      # Claude config directory
      - CLAUDE_CONFIG_DIR=/home/ubuntu/.claude
      # Optional API keys if needed (Gemini uses OAuth in ~/.gemini/)
      - ANTHROPIC_API_KEY
      - GITHUB_TOKEN
      - CURSOR_API_KEY
      - OPENAI_API_KEY
      - CLAUDE_CODE_OAUTH_TOKEN
      # Deep research providers (foundry-mcp)
      - TAVILY_API_KEY
      - PERPLEXITY_API_KEY
      - GOOGLE_API_KEY
      - GOOGLE_CSE_ID
      - TERM=xterm-256color
