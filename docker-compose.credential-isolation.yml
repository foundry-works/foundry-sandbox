# Credential Isolation Override
#
# Use with: docker-compose -f docker-compose.yml -f docker-compose.credential-isolation.yml up
#
# This override:
# 1. Adds api-proxy service that holds API credentials
# 2. Configures dev service to route traffic through the proxy
# 3. Removes API keys from dev service environment
#
# Requires: API keys passed to api-proxy service via environment variables

services:
  # API Proxy - holds credentials, injects into API requests
  api-proxy:
    build:
      context: ./api-proxy
    image: foundry-api-proxy

    # API credentials (passed from host environment)
    environment:
      - CLAUDE_CODE_OAUTH_TOKEN
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GOOGLE_API_KEY
      - GEMINI_API_KEY
      - GROQ_API_KEY
      - MISTRAL_API_KEY
      - DEEPSEEK_API_KEY
      - TOGETHER_API_KEY
      - OPENROUTER_API_KEY
      - FIREWORKS_API_KEY
      - TAVILY_API_KEY
      - SEMANTIC_SCHOLAR_API_KEY
      - PERPLEXITY_API_KEY
      - CURSOR_API_KEY
      - PROXY_MODE=regular
      - PROXY_LOG_LEVEL=${PROXY_LOG_LEVEL:-info}
      # OAuth support for Codex CLI
      - CODEX_AUTH_FILE=/credentials/codex/auth.json
      # OAuth support for OpenCode CLI
      - OPENCODE_AUTH_FILE=/credentials/opencode/auth.json
      # OAuth support for Gemini CLI
      - GEMINI_OAUTH_FILE=/credentials/gemini/oauth_creds.json

    volumes:
      # Shared certificate volume - proxy writes CA, sandbox reads it
      - mitm-certs:/etc/proxy/certs
      # Codex OAuth credentials (mount specific file only)
      - ${HOME}/.codex/auth.json:/credentials/codex/auth.json:ro
      # OpenCode OAuth credentials (mount specific file only)
      - ${HOME}/.local/share/opencode/auth.json:/credentials/opencode/auth.json:ro
      # Gemini OAuth credentials (mount specific file only)
      - ${HOME}/.gemini/oauth_creds.json:/credentials/gemini/oauth_creds.json:ro

    networks:
      credential-isolation: {}
      default: {}

    # Container always restarts unless explicitly stopped
    restart: unless-stopped

    # Healthcheck - verify proxy port is listening
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost', 8080)); s.close()"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Dev service overrides for credential isolation
  dev:
    depends_on:
      api-proxy:
        condition: service_healthy

    volumes:
      # Mount shared certificate volume (read-only for sandbox)
      - mitm-certs:/certs:ro
      # Stub auth files mounted to staging location (entrypoint copies to writable home)
      # This allows CLI tools to write to auth.json without leaking credentials
      - ./api-proxy/stub-auth-codex.json:/stub-auth/codex-auth.json:ro
      - ./api-proxy/stub-auth-opencode.json:/stub-auth/opencode-auth.json:ro
      - ./api-proxy/stub-auth-gemini.json:/stub-auth/gemini-oauth_creds.json:ro

    networks:
      - credential-isolation

    environment:
      # Tell firewall to allow the credential proxy
      - SANDBOX_CREDENTIAL_PROXY=api-proxy

      # Explicit proxy config for outbound API traffic
      - HTTP_PROXY=http://api-proxy:8080
      - HTTPS_PROXY=http://api-proxy:8080
      - NO_PROXY=localhost,127.0.0.1,api-proxy
      # Trust the mitmproxy CA certificate for HTTPS interception
      - NODE_EXTRA_CA_CERTS=/certs/mitmproxy-ca.pem
      - REQUESTS_CA_BUNDLE=/certs/mitmproxy-ca.pem
      - SSL_CERT_FILE=/certs/mitmproxy-ca.pem
      - CURL_CA_BUNDLE=/certs/mitmproxy-ca.pem

      # Placeholder API keys - tools see these as "authenticated"
      # Proxy intercepts requests and injects real credentials
      # NOTE: ANTHROPIC_API_KEY is NOT set here - it's conditionally added
      # at runtime by add_anthropic_credential_to_override() only when
      # OAuth is not available. This prevents the "Detected custom API key"
      # prompt when OAuth is configured on the host.
      # NOTE: GEMINI_API_KEY and GOOGLE_API_KEY are conditionally added by
      # add_gemini_credential_to_override() only when OAuth credentials
      # (~/.gemini/oauth_creds.json) are not available. When OAuth is available,
      # these are explicitly cleared to force the CLI to use OAuth.
      # NOTE: CLAUDE_CODE_OAUTH_TOKEN must be overridden to prevent
      # the real token from leaking in from docker-compose.yml
      - CLAUDE_CODE_OAUTH_TOKEN=CREDENTIAL_PROXY_PLACEHOLDER
      - OPENAI_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - GROQ_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - MISTRAL_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - DEEPSEEK_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - TOGETHER_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - OPENROUTER_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - FIREWORKS_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - TAVILY_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - SEMANTIC_SCHOLAR_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - PERPLEXITY_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
      - CURSOR_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER

      # Keep non-credential env vars from base compose
      # (they're inherited, but listing here for clarity)
      # - CLAUDE_CONFIG_DIR
      # - CLAUDE_CODE_TMPDIR
      # - etc.

# Isolated network for credential proxy communication
networks:
  credential-isolation:
    driver: bridge
    internal: true

# Shared volume for mitmproxy CA certificate
volumes:
  mitm-certs:
