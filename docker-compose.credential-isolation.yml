# Credential Isolation Override
#
# Use with: docker-compose -f docker-compose.yml -f docker-compose.credential-isolation.yml up
#
# This override:
# 1. Adds unified-proxy service that holds API/Git credentials and filters traffic
# 2. Configures dev service to route all traffic through the proxy
# 3. Removes credentials from dev service environment
#
# The unified-proxy handles:
# - HTTP/HTTPS proxy (port 8080) with credential injection
# - DNS filtering (port 53) with allowlist enforcement
# - Git protocol filtering (blocks dangerous operations)
#
# Requires: API keys passed via environment variables
# Optional: GITHUB_TOKEN or GH_TOKEN for authenticated GitHub access

services:
    # Unified Proxy - holds credentials, injects into API requests, filters DNS/Git
    unified-proxy:
        build:
            context: ./unified-proxy
        image: foundry-unified-proxy

        # Drop dangerous capabilities for defense-in-depth
        cap_drop:
            - NET_RAW
            - NET_ADMIN
        # Allow binding to DNS port 53 without running as root
        cap_add:
            - NET_BIND_SERVICE

        # API and Git credentials (passed from host environment)
        environment:
            # Git credentials (previously in gateway)
            - GITHUB_TOKEN
            - GH_TOKEN
            # API credentials
            - CLAUDE_CODE_OAUTH_TOKEN
            - ANTHROPIC_API_KEY
            - GOOGLE_API_KEY
            - GEMINI_API_KEY
            - TAVILY_API_KEY
            - SEMANTIC_SCHOLAR_API_KEY
            - PERPLEXITY_API_KEY
            - ZHIPU_API_KEY
            # Proxy configuration
            - PROXY_MODE=regular
            - PROXY_LOG_LEVEL=${PROXY_LOG_LEVEL:-info}
            # Internal API socket for container registration
            - INTERNAL_API_SOCKET=/var/run/proxy/internal.sock
            # Registry database path (persistent volume)
            - REGISTRY_DB_PATH=/var/lib/unified-proxy/registry.db
            # Enable DNS filtering mode
            - PROXY_ENABLE_DNS=true
            # PR operations control - when set to 'true', allows PR create/comment/review
            - ALLOW_PR_OPERATIONS=${ALLOW_PR_OPERATIONS:-}
            # OAuth support for Codex CLI
            - CODEX_AUTH_FILE=/credentials/codex/auth.json
            # OAuth support for OpenCode CLI
            - OPENCODE_AUTH_FILE=/credentials/opencode/auth.json
            # Control whether OpenCode auth is enabled (passed from sandbox.sh)
            - SANDBOX_ENABLE_OPENCODE
            # OAuth support for Gemini CLI
            - GEMINI_OAUTH_FILE=/credentials/gemini/oauth_creds.json
            # Git shadow mode: proxy serves git API for sandboxed git operations
            - GIT_SHADOW_ENABLED=true
            # HMAC secrets path for git API authentication
            - GIT_API_SECRETS_PATH=/run/secrets/sandbox-hmac

        volumes:
            # Shared certificate volume - proxy writes CA, sandbox reads it
            - mitm-certs:/etc/proxy/certs
            # Internal API socket + runtime state (PID file, readiness marker)
            - proxy-runtime:/var/run/proxy
            # Registry database persistence
            - proxy-data:/var/lib/unified-proxy
            # Codex OAuth credentials (mount specific file only)
            - ${HOME}/.codex/auth.json:/credentials/codex/auth.json:ro
            # OpenCode OAuth credentials (mount specific file only)
            - ${HOME}/.local/share/opencode/auth.json:/credentials/opencode/auth.json:ro
            # Gemini OAuth credentials (mount specific file only)
            - ${HOME}/.gemini/oauth_creds.json:/credentials/gemini/oauth_creds.json:ro
            # Hostname allowlist for egress filtering
            - ./config/firewall-allowlist.txt:/etc/proxy/config/firewall-allowlist.txt:ro
            # Unified proxy allowlist config (policy engine + DNS filter)
            - ./config/allowlist.yaml:/etc/unified-proxy/allowlist.yaml:ro
            # Git shadow: workspace bind mount (shared working tree with sandbox)
            - ${WORKSPACE_PATH:-.}:/git-workspace
            # Git shadow: bare repos for commit storage (RW)
            - ${REPOS_DIR:-/tmp/sandbox-repos}:/home/ubuntu/.sandboxes/repos
            # Git shadow: per-sandbox HMAC secrets for git API authentication
            - sandbox-hmac-secrets:/run/secrets/sandbox-hmac:ro

        # Git API port - accessible only on credential-isolation network
        expose:
            - "8083"

        # SECURITY: unified-proxy on credential-isolation (internal) + proxy-egress (external)
        # - credential-isolation: internal network for sandbox communication
        # - proxy-egress: allows outbound API/Git calls but is separate from 'default'
        #
        # This prevents credential exfiltration via the default network while still
        # allowing the proxy to reach external services through a dedicated egress path.
        networks:
            credential-isolation:
                aliases:
                    # DNS alias so sandbox can use unified-proxy as DNS server
                    - unified-proxy-dns
            proxy-egress: {}

        # Container always restarts unless explicitly stopped
        restart: unless-stopped

        # Healthcheck - verify internal API is responsive via Unix socket
        healthcheck:
            test: ["CMD", "curl", "-sf", "--unix-socket", "/var/run/proxy/internal.sock", "http://localhost/internal/health"]
            interval: 5s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Dev service overrides for credential isolation
    # Sandbox container - only on internal network, no direct external access
    dev:
        depends_on:
            unified-proxy:
                condition: service_healthy

        # Start as root to configure DNS, then drop to sandbox user
        # The entrypoint-root.sh resolves 'unified-proxy' IP dynamically and writes /etc/resolv.conf
        # This allows multiple sandboxes to run simultaneously (no static IP conflicts)
        user: root
        entrypoint: ["/usr/local/bin/entrypoint-root.sh"]

        volumes:
            # Mount shared certificate volume (read-only for sandbox)
            - mitm-certs:/certs:ro
            # Proxy stub files from named volume (populated by populate_stubs_volume)
            # Uses volume instead of bind mounts to avoid Docker Desktop VirtioFS staleness
            - proxy-stubs:/etc/proxy-stubs:ro
            # Git shadow: wrapper script intercepts git commands and proxies to git API
            - ./stubs/git-wrapper.sh:/usr/local/bin/git:ro
            # Git shadow: per-sandbox HMAC secret for authenticating with git API
            - sandbox-hmac-secrets:/run/secrets/sandbox-hmac:ro

        # Git shadow: tmpfs overlay hides .git metadata from sandbox
        tmpfs:
            - /workspace/.git:mode=755,uid=1000,gid=1000,size=1m

        networks:
            - credential-isolation

        # Override read_only from base compose - required for DNS configuration.
        # Accepted risk: sandbox can write to non-tmpfs paths. Mitigated by:
        #   - Non-root user (uid 1000 via gosu)
        #   - Network isolation (internal: true) blocks exfiltration
        #   - Tmpfs /home means writes don't persist across restarts
        #   - Worktree is read-only; /workspace/.git is a tmpfs overlay
        # See docs/security/sandbox-threats.md "Container Filesystem Write Capability"
        read_only: false

        # NET_ADMIN required for iptables DNS firewall rules in entrypoint-root.sh.
        # Accepted risk: capability granted at container start. Mitigated by:
        #   - Privilege drop to uid 1000 via gosu after iptables setup
        #   - Unprivileged user cannot modify iptables (requires euid 0)
        # See docs/security/sandbox-threats.md "NET_ADMIN Capability"
        cap_add:
            - NET_ADMIN

        # Drop NET_RAW capability to prevent IP spoofing, ARP poisoning, and packet sniffing.
        # This is critical for supply chain attack protection - malicious packages cannot
        # craft raw packets to bypass network isolation (ICC=false).
        cap_drop:
            - NET_RAW

        environment:
            # Explicit proxy config for outbound API traffic
            - HTTP_PROXY=http://unified-proxy:8080
            - HTTPS_PROXY=http://unified-proxy:8080
            - NO_PROXY=localhost,127.0.0.1,unified-proxy
            # Trust the mitmproxy CA certificate for HTTPS interception
            - NODE_EXTRA_CA_CERTS=/certs/mitmproxy-ca.pem
            - REQUESTS_CA_BUNDLE=/certs/mitmproxy-ca.pem
            - SSL_CERT_FILE=/certs/mitmproxy-ca.pem
            - CURL_CA_BUNDLE=/certs/mitmproxy-ca.pem

            # Force Node.js apps to use proxy (global-agent bootstrap)
            - NODE_OPTIONS=--require /usr/lib/node_modules/global-agent/bootstrap.js
            - GLOBAL_AGENT_HTTP_PROXY=http://unified-proxy:8080
            - GLOBAL_AGENT_HTTPS_PROXY=http://unified-proxy:8080
            - GLOBAL_AGENT_NO_PROXY=localhost,127.0.0.1,unified-proxy

            # CRITICAL: Unset GitHub tokens - dev must NOT have direct GitHub access
            # Git operations go through unified-proxy which holds the real credentials
            - GITHUB_TOKEN=
            - GH_TOKEN=

            # Placeholder API keys - tools see these as "authenticated"
            # Proxy intercepts requests and injects real credentials
            # Claude and Gemini use conditional placeholders based on host auth config:
            # - If host uses OAuth, sandbox gets OAuth placeholder (not API key)
            # - If host uses API key, sandbox gets API key placeholder
            # This is set by setup_credential_placeholders() in lib/docker.sh
            - ANTHROPIC_API_KEY=${SANDBOX_ANTHROPIC_API_KEY:-}
            - CLAUDE_CODE_OAUTH_TOKEN=${SANDBOX_CLAUDE_OAUTH:-}
            - OPENAI_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
            - GOOGLE_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
            - GEMINI_API_KEY=${SANDBOX_GEMINI_API_KEY:-}
            - TAVILY_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
            - SEMANTIC_SCHOLAR_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
            - PERPLEXITY_API_KEY=CREDENTIAL_PROXY_PLACEHOLDER
            - ZHIPU_API_KEY=${SANDBOX_ZHIPU_API_KEY:-}
            - SANDBOX_ENABLE_OPENCODE
            - SANDBOX_ENABLE_ZAI
            - SANDBOX_ENABLE_TAVILY
            # Credential isolation flag for entrypoint behaviors
            - SANDBOX_GATEWAY_ENABLED=true
            # Git shadow mode configuration
            - GIT_SHADOW_ENABLED=true
            - GIT_API_HOST=unified-proxy
            - GIT_API_PORT=8083
            # Sandbox identity for HMAC authentication with git API
            - SANDBOX_ID=${SANDBOX_ID:-}

# Isolated network for credential proxy communication
# - internal: true = no external network access
# - ICC enabled = containers can communicate (required for dev -> unified-proxy)
# Note: Each sandbox project has its own isolated network, so ICC doesn't
# compromise isolation between different sandboxes.
networks:
    credential-isolation:
        driver: bridge
        internal: true

    # Dedicated egress network for unified-proxy
    # Allows outbound connections to external APIs (github.com, api.anthropic.com, etc.)
    # Separate from 'default' to limit attack surface if proxy is compromised
    proxy-egress:
        driver: bridge
        # NOT internal - allows outbound connections

# Shared volumes
volumes:
    # mitmproxy CA certificate (unified-proxy writes, sandbox reads)
    mitm-certs:
    # Proxy registry database persistence
    proxy-data:
    # Proxy runtime state (Unix socket, PID, readiness marker)
    proxy-runtime:
    # Stubs volume (pre-created by populate_stubs_volume before compose up)
    # External volume avoids Docker Desktop bind mount staleness issues
    proxy-stubs:
        name: ${STUBS_VOLUME_NAME:-proxy-stubs}
        external: true
    # Per-sandbox HMAC secrets for git API authentication
    # Provisioned by commands/new.sh during sandbox creation
    sandbox-hmac-secrets:
        name: ${HMAC_VOLUME_NAME:-sandbox-hmac-secrets}
        external: true
