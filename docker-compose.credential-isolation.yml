# Credential Isolation Override
#
# Use with: docker-compose -f docker-compose.yml -f docker-compose.credential-isolation.yml up
#
# This override:
# 1. Adds api-proxy service that holds API credentials
# 2. Configures dev service to route traffic through the proxy
# 3. Removes API keys from dev service environment
#
# Requires: API keys passed to api-proxy service via environment variables

services:
  # API Proxy - holds credentials, injects into API requests
  api-proxy:
    build:
      context: ./api-proxy
    image: foundry-api-proxy

    # API credentials (passed from host environment)
    environment:
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GOOGLE_API_KEY
      - GROQ_API_KEY
      - MISTRAL_API_KEY
      - DEEPSEEK_API_KEY
      - TOGETHER_API_KEY
      - OPENROUTER_API_KEY
      - FIREWORKS_API_KEY
      - PROXY_MODE=transparent
      - PROXY_LOG_LEVEL=${PROXY_LOG_LEVEL:-info}

    volumes:
      # Shared certificate volume - proxy writes CA, sandbox reads it
      - mitm-certs:/etc/proxy/certs

    networks:
      credential-isolation:
        # Static IP so sandbox iptables rules work reliably
        ipv4_address: 172.28.0.2

    # Container always restarts unless explicitly stopped
    restart: unless-stopped

    # Healthcheck via mitmproxy web interface
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8081/"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Dev service overrides for credential isolation
  dev:
    depends_on:
      api-proxy:
        condition: service_healthy

    # Additional capabilities needed for iptables
    cap_add:
      - NET_ADMIN

    volumes:
      # Mount shared certificate volume (read-only for sandbox)
      - mitm-certs:/certs:ro

    networks:
      - credential-isolation

    environment:
      # Enable credential isolation mode
      - CREDENTIAL_ISOLATION=1
      # Proxy port for iptables redirect (default matches api-proxy)
      - CREDENTIAL_PROXY_PORT=8080

      # Clear API keys - they're in api-proxy, not here
      - ANTHROPIC_API_KEY=
      - OPENAI_API_KEY=
      - GOOGLE_API_KEY=
      - GROQ_API_KEY=
      - MISTRAL_API_KEY=
      - DEEPSEEK_API_KEY=
      - TOGETHER_API_KEY=
      - OPENROUTER_API_KEY=
      - FIREWORKS_API_KEY=

      # Keep non-credential env vars from base compose
      # (they're inherited, but listing here for clarity)
      # - CLAUDE_CONFIG_DIR
      # - CLAUDE_CODE_TMPDIR
      # - etc.

# Isolated network for credential proxy communication
networks:
  credential-isolation:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# Shared volume for mitmproxy CA certificate
volumes:
  mitm-certs:
